<?php 
if( !defined("ADMIN_LOADED") ) 
{
    exit();
}

list($browsers, $oses, $countries) = Browser2::getalldata(array( "browsers", "oses", "countries" ));
$widgetID = (isset($_POST["widgetID"]) ? intval($_POST["widgetID"]) : null);
if( $widgetID != null ) 
{
    $widgetData = db::selectone("*", "Widgets", "ID=" . $widgetID);
}

$threadData = Threads::getfulldata();
$imgPath = Config::get("AdminScriptName") . "?" . Config::get("MainParamName") . "=file&type=img&file=";
$title = Lang::get("widgetTitle");
echo "<div class=\"main\">\r\n\t<div class=\"menu\">\r\n\t\t<ul>\r\n\t\t\t<li class=\"active\"><div><div><a href=\"javascript:Widgets.show('browsers');\" id=\"browsers\">";
echo Lang::get("StatisticsBrowsersLabel");
echo "</a></div></div></li>\r\n\t\t\t<li><div><div><a href=\"javascript:Widgets.show('oses');\" id=\"oses\">";
echo Lang::get("StatisticsOSLabel");
echo "</a></div></div></li>\r\n\t\t\t<li><div><div><a href=\"javascript:Widgets.show('countries');\" id=\"countries\">";
echo Lang::get("StatisticsCountriesLabel");
echo "</a></div></div></li>\r\n\t\t\t<li><div><div><a href=\"javascript:Widgets.show('threads');\" id=\"threads\">";
echo Lang::get("StatisticsThreadsLabel");
echo "</a></div></div></li>\r\n\t\t</ul>\r\n\t\t<div class=\"close\" id=\"addWidgetClose\"></div>\r\n\t</div>\r\n\t<div style=\"clear:both;\"></div>\r\n\t<div class=\"left\">\r\n\t\t<div class=\"controls\">\r\n\t\t\t<div><a href=\"javascript:Widgets.checkAll()\"><img src=\"";
echo $imgPath;
echo "check.png\" width=\"15px\" height=\"11px\"/> ";
echo Lang::get("CheckAll");
echo "</a></div>\r\n\t\t\t<div><a href=\"javascript:Widgets.uncheckAll()\"><img src=\"";
echo $imgPath;
echo "check2.png\" width=\"15px\" height=\"11px\"/> ";
echo Lang::get("UncheckAll");
echo "</a></div>\r\n\t\t\t<div class=\"search\" onclick=\"Widgets.showSearch()\"><img src=\"";
echo $imgPath;
echo "search.png\" width=\"13px\" height=\"13px\"/></div>\r\n\t\t\t<div class=\"searchStr\" style=\"display:none;\"><input type=\"text\" id=\"searchStr\" onkeyup=\"Widgets.filter()\" style=\"width:0px;\"/></div>\r\n\t\t</div>\r\n\t\t<div class=\"widgetList\" id=\"browsersDiv\">\r\n\t\t\t<ul>\r\n\t\t\t\t";
foreach( $browsers as $k => $arr ) 
{
    echo "\t\t\t\t\t<li ";
    if( $k % 2 ) 
    {
        echo "class=\"odd\"";
    }

    echo " onclick=\"Widgets.toggle('browser-";
    echo $arr["id"];
    echo "','browsers','";
    if( isset(Browser::$icons["browsers"][$arr["id"]]) ) 
    {
        echo Browser::$icons["browsers"][$arr["id"]];
    }

    echo ".gif')\"><a id=\"browser-";
    echo $arr["id"];
    echo "\">";
    echo $arr["title"];
    echo "</a></li>\r\n\t\t\t\t";
}
echo "\t\t\t</ul>\r\n\t\t</div>\r\n\t\t<div class=\"widgetList\" id=\"osesDiv\" style=\"display:none;\">\r\n\t\t\t<ul>\r\n\t\t\t\t";
foreach( $oses as $k => $arr ) 
{
    echo "\t\t\t\t\t<li ";
    if( $k % 2 ) 
    {
        echo "class=\"odd\"";
    }

    echo " onclick=\"Widgets.toggle('oses-";
    echo $arr["id"];
    echo "','oses','";
    if( isset(Browser::$icons["oses"][$arr["id"]]) ) 
    {
        echo Browser::$icons["oses"][$arr["id"]];
    }

    echo ".gif')\"><a id=\"oses-";
    echo $arr["id"];
    echo "\">";
    echo $arr["title"];
    echo "</a></li>\r\n\t\t\t\t";
}
echo "\t\t\t</ul>\r\n\t\t</div>\r\n\t\t<div id=\"scrollbar_container\">  \r\n\t\t\t<div id=\"scrollbar_track_countries\"><div id=\"scrollbar_handle\"></div></div>  \r\n\t\t\t<div class=\"widgetList\" id=\"countriesDiv\" style=\"display:none;\">\r\n\t\t\t\t<ul>\r\n\t\t\t\t\t";
foreach( $countries as $k => $arr ) 
{
    echo "\t\t\t\t\t\t<li ";
    if( $k % 2 ) 
    {
        echo "class=\"odd\"";
    }

    echo " onclick=\"Widgets.toggle('countries_";
    echo $arr["id"];
    echo "','countries','countries/";
    echo strtolower(Browser::$countryCodes[$arr["id"]]);
    echo ".gif')\"><a id=\"countries_";
    echo $arr["id"];
    echo "\">";
    echo $arr["title"];
    echo "</a></li>\r\n\t\t\t\t\t";
}
echo "\t\t\t\t</ul>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div id=\"scrollbar_container\">  \r\n\t\t\t<div id=\"scrollbar_track_threads\"><div id=\"scrollbar_handle\"></div></div>  \r\n\t\t\t<div class=\"widgetList\" id=\"threadsDiv\" style=\"display:none;\">\r\n\t\t\t\t<ul>\r\n\t\t\t\t\t";
foreach( $threadData as $id => $arr ) 
{
    echo "\t\t\t\t\t\t<li ";
    if( $id % 2 ) 
    {
        echo "class=\"odd\"";
    }

    echo " onclick=\"Widgets.toggle('threads_";
    echo $arr["ID"];
    echo "','threads')\"><a id=\"threads_";
    echo $arr["ID"];
    echo "\">";
    echo $arr["Title"];
    echo "</a></li>\r\n\t\t\t\t\t";
}
echo "\t\t\t\t</ul>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class=\"right\">\r\n\t\t<div id=\"scrollbar_container\">  \r\n\t\t\t<div id=\"scrollbar_track_result\"><div id=\"scrollbar_handle\"></div></div>  \r\n\t\t\t<div id=\"resultsDiv\">\r\n\t\t\t\t<span>";
echo Lang::get("StatisticsBrowsersLabel");
echo "</span>\r\n\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t<ul id=\"browsersResult\"></ul>\r\n\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\r\n\t\t\t\t<span>";
echo Lang::get("StatisticsOSLabel");
echo "</span>\r\n\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t<ul id=\"osesResult\"></ul>\r\n\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t\r\n\t\t\t\t<span>";
echo Lang::get("StatisticsCountriesLabel");
echo "</span>\r\n\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t<ul id=\"countriesResult\"></ul>\r\n\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t<div id=\"allCountries\" style=\"display:none;\">\r\n\t\t\t\t\t<img src=\"";
echo $imgPath;
echo "all_countries.png\" width=\"123px\" height=\"128px\"/>\r\n\t\t\t\t\t<br/>\r\n\t\t\t\t\t";
echo Lang::get("allCountries");
echo "\t\t\t\t</div>\r\n\t\t\t\t\r\n\t\t\t\t<span>";
echo Lang::get("StatisticsThreadsLabel");
echo "</span>\r\n\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t\t<ul id=\"threadsResult\"></ul>\r\n\t\t\t\t<div style=\"clear:both;\"></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div class=\"title\">\r\n\t\t\t<input type=\"text\" onfocus=\"if(this.value=='";
echo $title;
echo "'){this.value='';this.style.color='#000';};\" onblur=\"if(this.value==''){this.value='";
echo $title;
echo "';this.style.color='#bbb';};\" class=\"text\" id=\"newWidgetTitle\"";
echo ($widgetID != null ? "value=\"" . iconv("windows-1251", "utf-8", $widgetData["Title"]) . "\"" : "value=\"" . $title . "\"");
echo ($widgetID != null ? " style=\"color:#000\"" : "");
echo "/>\r\n\t\t\t<input type=\"button\" value=\"";
echo Lang::get("ConfigSubmitButton");
echo "\" onclick=\"Widgets.save()\" class=\"save\"/>\r\n\t\t</div>\r\n\t</div>\r\n\t\r\n\t<div style=\"clear:both;\"></div>\r\n\t";
if( $widgetID != null ) 
{
    echo "\t\t<script>\r\n\t\t\t";
    $browsers = explode(",", $widgetData["browsers"]);
    if( $widgetData["browsers"] == "" ) 
    {
        $browsers = array(  );
    }

    $countries = explode(",", $widgetData["countries"]);
    if( $widgetData["countries"] == "" ) 
    {
        $countries = array(  );
    }

    $oses = explode(",", $widgetData["oses"]);
    if( $widgetData["oses"] == "" ) 
    {
        $oses = array(  );
    }

    $threads = explode(",", $widgetData["threads"]);
    if( $widgetData["threads"] == "" ) 
    {
        $threads = array(  );
    }

    echo "\t\t\t\r\n\t\t\t";
    foreach( $browsers as $t ) 
    {
        if( $t == "" ) 
        {
            continue;
        }

        echo "Widgets.toggle('browser-";
        echo $t;
        echo "', 'browsers','";
        if( isset(Browser::$icons["browsers"][$t]) ) 
        {
            echo Browser::$icons["browsers"][$t];
        }

        echo ".gif');";
    }
    echo "\t\t\t";
    foreach( $countries as $t ) 
    {
        if( $t == "" ) 
        {
            continue;
        }

        echo "Widgets.toggle('countries_";
        echo $t;
        echo "', 'countries','countries/";
        echo strtolower(Browser::$countryCodes[$t]);
        echo ".gif');";
    }
    echo "\t\t\t";
    foreach( $oses as $t ) 
    {
        if( $t == "" ) 
        {
            continue;
        }

        echo "Widgets.toggle('oses-";
        echo $t;
        echo "', 'oses','";
        if( isset(Browser::$icons["oses"][$t]) ) 
        {
            echo Browser::$icons["oses"][$t];
        }

        echo ".gif');";
    }
    echo "\t\t\t";
    foreach( $threads as $t ) 
    {
        if( $t == "" ) 
        {
            continue;
        }

        echo "Widgets.toggle('threads_";
        echo $t;
        echo "', 'threads');";
    }
    echo "\t\t</script>\r\n\t";
}

echo "</div>";

