<?php 
if( !defined("ADMIN_LOADED") ) 
{
    exit();
}

$id = $_SESSION["NewWidgetID"];
$startDate = (isset($_GET["startDate"]) && ereg("^[0-9]{2}\\.[0-9]{2}\\.[0-9]{4}\$", $_GET["startDate"]) ? strtotime($_GET["startDate"]) : null);
$endDate = (isset($_GET["endDate"]) && ereg("^[0-9]{2}\\.[0-9]{2}\\.[0-9]{4}\$", $_GET["endDate"]) ? strtotime($_GET["endDate"]) : null);
$threadID = (isset($_GET["threadID"]) ? intval($_GET["threadID"]) : null);
$widgetsData = Logs::getstatisticsbywidgets($startDate, $endDate, $threadID);
$widgetData = $widgetsData[$id];
echo "\r\n<div class=\"block widget\" id=\"widget-";
echo $id;
echo "\">\r\n\t<script>\r\n\t\tvar table = createTable('widgets-";
echo $id;
echo "', 'widget-";
echo $id;
echo "', '";
echo Logs::$WidgetTitles[$id];
echo "', true);\r\n\t\ttable.staticParams = Tables.browsers.staticParams;\r\n\t\ttable.allowFullLoad = false;\r\n\t\ttable.limit = 9999;\r\n\t\ttable.otherTitle = '";
echo Lang::get("StatisticsOtherLabel");
echo "';\r\n\t\ttable.lastSort = '";
echo Prefs::get("widgets-" . $id . "Sort");
echo "';\r\n\t\ttable.lastDest = '";
echo Prefs::get("widgets-" . $id . "Dest");
echo "';\r\n\t\ttable.setData([\r\n";
$max = 0;
foreach( $widgetData as $num => $entry ) 
{
    if( $max < $entry["Hosts"] ) 
    {
        $max = $entry["Hosts"];
    }

}
foreach( $widgetData as $num => $entry ) 
{
    echo "{\r\n\tID : ";
    echo $entry["ID"];
    echo ",\r\n\tTitle : '";
    echo $entry["Title"];
    echo "',\r\n\tHosts : '";
    echo $entry["Hosts"];
    echo "',\r\n\tHosts2 : '";
    echo $entry["Hosts2"];
    echo "',\r\n\tHited : '";
    echo $entry["Hited"];
    echo "',\r\n\tExecuted : '";
    echo $entry["Executed"];
    echo "',\r\n\tMaxHosts : '";
    echo $max;
    echo "',\r\n\tType : '";
    echo $entry["Type"];
    echo "'\r\n}\r\n";
    if( $num != count($widgetData) - 1 ) 
    {
        echo ",";
    }

}
echo "\t\t\t\r\n\t\t], true);\r\n\t\tTables['widgets-";
echo $id;
echo "'] = table;\r\n\t\tPortalSettings = {\r\n\t\t\t\t\t\t\t'column-1' : [";
echo Prefs::get("column-1");
echo "],\r\n\t\t\t\t\t\t\t'column-2' : [";
echo Prefs::get("column-2");
echo "]\r\n\t\t\t\t\t\t};\r\n\t\tportal = new Portal(PortalSettings, options, {});\r\n\t</script>\r\n</div>";

